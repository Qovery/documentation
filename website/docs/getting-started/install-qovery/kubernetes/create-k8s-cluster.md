---
last_modified_on: "2024-01-11"
title: "Create Demo Cluster"
description: "Learn how to create a Kubernetes cluster with k3d for demo purposes"
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import Steps from '@site/src/components/Steps';
import Alert from '@site/src/components/Alert';
import Assumptions from '@site/src/components/Assumptions';

<Alert type="warning">

This setup is just for demo purposes. If you want to use Qovery in production, you should use a managed Kubernetes cluster or even k3d but with a better setup. Feel free to contact us on our [Community forum][urls.qovery_forum] if you need help.

</Alert>

This page explains how to set up a local Kubernetes cluster with [k3d](https://k3d.io).

<Assumptions>

* You have [helm][urls.helm] installed on your machine

</Assumptions>

<!--
     THIS FILE IS AUTOGENERATED!

     To make changes please edit the template located at:

     website/docs/getting-started/install-qovery/kubernetes/create-k8s-cluster.md.erb
-->

## ⚠️ Important temporary limitations

In our current state of Qovery BYOK development, we have some hard requirements, like the need of a supported Container Registry ([AWS ECR](https://aws.amazon.com/ecr/) or [GCP GCR](https://cloud.google.com/artifact-registry)). This is a temporary limitation that will be removed within February 2024. However, you can run Qovery BYOK on any Kubernetes cluster (and not only k3d) if you have a AWS ECR or GCP GCR container registry.

Non-exhaustive of possible setups:

- k3d + AWS ECR
- k3d + GCP GCR
- GCP GKE + GCP GCR
- AWS EKS + AWS ECR
- Azure AKS + AWS ECR or GCP GCR
- Digital Ocean Kubernetes + AWS ECR or GCP GCR
- Civo Kubernetes + AWS ECR or GCP GCR
- Any Kubernetes cluster + AWS ECR or GCP GCR

As soon as we have a supported Container Registry, you will be able to use Qovery BYOK on any Kubernetes cluster.

### Why Qovery needs a Container Registry?

Qovery requires a private container registry to store built images and mirror containers in order to reduce potential images deletion by 3rd party, while you still need them ([more info here][docs.using-qovery.deployment.image-mirroring]).

## Install and Run k3d

<Steps headingDepth={3}>

<ol>

<li>

### Choose a Container Registry

<Tabs
centered={true}
className={"rounded"}
defaultValue={"ecr"}
placeholder="Select a container registry"
select={false}
size={null}
values={[
  {"group":"Registry","label":"ECR","value":"ecr"},
  {"group":"Registry","label":"GCR","value":"gcr"},
]}>

<TabItem value="ecr">

Create an IAM user with the following policy, and generate an access key:

```json
{
    "Statement": [
        {
            "Action": [
                "ecr:*"
            ],
            "Effect": "Allow",
            "Resource": "*"
        }
    ],
    "Version": "2012-10-17"
}
```

Then, create a `config.yaml` file to configure the [ECR Credentials Provider](), where you should set the AWS credentials previously generated:

```yaml title="config.yaml"
apiVersion: kubelet.config.k8s.io/v1
kind: CredentialProviderConfig
providers:
  - name: ecr-credential-provider
    matchImages:
      - "*.dkr.ecr.*.amazonaws.com"
      - "*.dkr.ecr.*.amazonaws.com.cn"
      - "*.dkr.ecr-fips.*.amazonaws.com"
      - "*.dkr.ecr.us-iso-east-1.c2s.ic.gov"
      - "*.dkr.ecr.us-isob-east-1.sc2s.sgov.gov"
    defaultCacheDuration: "12h"
    apiVersion: credentialprovider.kubelet.k8s.io/v1
    env:
      - name: AWS_ACCESS_KEY_ID
        value: CHANGE_ME
      - name: AWS_DEFAULT_REGION
        value: CHANGE_ME
      - name: AWS_SECRET_ACCESS_KEY
        value: CHANGE_ME
```

Here we use the [Kubelet Credential Provider](https://kubernetes.io/blog/2022/12/22/kubelet-credential-providers/) to inject the AWS credentials into the pods. The `config.yaml` file is mounted into the Kubernetes nodes, and the `ecr-credential-provider` binary is also mounted into the nodes.

</TabItem>

<TabItem value="gcr">

Work in progress

</TabItem>

</Tabs>

</li>

<li>

### Install k3d

<Tabs
centered={true}
className={"rounded"}
defaultValue={"ecr"}
placeholder="Select a Container Registry"
select={false}
size={null}
values={[
{"group":"Registry","label":"ECR","value":"ecr"},
{"group":"Registry","label":"GCR","value":"gcr"},
]}>

<TabItem value="ecr">

Create the `registry_bin` folder and `ecr-credential-provider` file for the ECR Credential Provider service:

```bash
mkdir -p registry_bin
touch registry_bin/ecr-credential-provider
chmod 755 registry_bin/ecr-credential-provider
```

Now we can run a local Kubernetes cluster (update the path to `config.yaml` file, and the Kubernetes [image tag version](https://hub.docker.com/r/rancher/k3s/tags)):

```bash
k3d cluster create --image rancher/k3s:v1.26.11-k3s2 --k3s-arg "--disable=traefik,metrics-server@server:0" \
-v $(pwd)/registry_bin:/var/lib/rancher/credentialprovider/bin@server:0  \
-v $(pwd)/config.yaml:/var/lib/rancher/credentialprovider/config.yaml@server:0
```

Now we need to install the ECR Credential Provider binary into the Kubernetes nodes. We will use a Kubernetes Job to do that:

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: cloud-provider-repository-binary-builder
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: ecr-credential-builder
        image: alpine:3.18
        command:
          - /bin/sh
          - -c
          - |
            apk add -U ca-certificates tar zstd tzdata go git
            git clone https://github.com/kubernetes/cloud-provider-aws.git
            cd cloud-provider-aws/cmd/ecr-credential-provider
            CGO_ENABLED=0 go build -mod=readonly .
            chmod 755 ecr-credential-provider
            mkdir -p /mnt/host/var/lib/rancher/credentialprovider/bin/
            cp ecr-credential-provider /mnt/host/var/lib/rancher/credentialprovider/bin/
        volumeMounts:
        - mountPath: /mnt/host
          name: host
      volumes:
      - hostPath:
          path: /
          type: ""
        name: host
```

You can now move on the Qovery Helm deployment.

</TabItem>

<TabItem value="gcr">

Work in progress

</TabItem>

</Tabs>

</li>

<li>

### Check your cluster

<Tabs
centered={true}
className={"rounded"}
defaultValue={"ecr"}
placeholder="Select a Container Registry"
select={false}
size={null}
values={[
{"group":"Registry","label":"ECR","value":"ecr"},
{"group":"Registry","label":"GCR","value":"gcr"},
]}>

<TabItem value="ecr">

Run the following command to check that your cluster is ready with your ECR credentials:

```bash
TODO
```

</TabItem>

<TabItem value="gcr">

Work in progress

</TabItem>

</Tabs>

</li>

</ol>

</Steps>

## Next Steps

Congratulations! You have successfully created a Kubernetes cluster with k3d. You are now ready to install Qovery BYOK on your cluster. Next step: [Install Qovery BYOK][docs.getting-started.install-qovery.kubernetes.quickstart#install-qovery]


[docs.getting-started.install-qovery.kubernetes.quickstart#install-qovery]: /docs/getting-started/install-qovery/kubernetes/quickstart/#install-qovery
[docs.using-qovery.deployment.image-mirroring]: /docs/using-qovery/deployment/image-mirroring/
[urls.helm]: https://helm.sh
[urls.qovery_forum]: https://discuss.qovery.com/

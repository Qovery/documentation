<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="preconnect" href="https://phprox.qovery.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,c){function a(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==c?g=e[c]=[]:c="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==c&&(e+="."+c),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)a(g,o[p]);e._i.push([r,s,c])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_IgdG1K2GveDUte1gJ6hlwNbFHCv9nViWETUyLMU7ciq",{api_host:"https://phprox.qovery.com"})</script>
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Qovery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Qovery Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">
<script src="/js/intercom.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=UA-129773960-5" async></script>
<script src="/js/ga.js"></script>

<title data-react-helmet="true">How to setup rate limit on services | Qovery</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="How to setup rate limit on services | Qovery"><meta data-react-helmet="true" name="msapplication-TileColor" content="#da532c"><meta data-react-helmet="true" name="theme-color" content="#ffffff"><meta data-react-helmet="true" name="description" content="How to setup rate limit on services, in minutes, for free"><meta data-react-helmet="true" property="og:description" content="How to setup rate limit on services, in minutes, for free"><meta data-react-helmet="true" property="og:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" property="twitter:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for How to setup rate limit on services | Qovery"><meta data-react-helmet="true" property="og:url" content="https://docs.qovery.com/guides/tutorial/how-to-setup-rate-limit-on-services/"><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="icon" href="/favicons/favicon.svg"><link data-react-helmet="true" rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link data-react-helmet="true" rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"><link data-react-helmet="true" rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><link data-react-helmet="true" rel="manifest" href="/favicons/site.webmanifest"><link data-react-helmet="true" rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5"><link data-react-helmet="true" rel="canonical" href="https://docs.qovery.com/guides/tutorial/how-to-setup-rate-limit-on-services/">


<link rel="stylesheet" href="/styles.90c21fa3.css">


<link rel="preload" href="/styles.255c8fd1.js" as="script">

<link rel="preload" href="/runtime~main.a03f576a.js" as="script">

<link rel="preload" href="/main.7be101da.js" as="script">

<link rel="preload" href="/1.385570ab.js" as="script">

<link rel="preload" href="/2.91632de6.js" as="script">

<link rel="preload" href="/3.ac200c48.js" as="script">

<link rel="preload" href="/1c13b173.a1d42003.js" as="script">

<link rel="preload" href="/58cf8c02.3058a95c.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_2ZIa"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/tutorial">Tutorials</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://start.qovery.com">Web Console</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"><i class="feather icon-github"></i> </a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_16CL"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/tutorial">Tutorials</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://start.qovery.com">Web Console</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"></a></li></ul></div></div></div></nav><div class="main-wrapper"><header class="hero domain-bg domain-bg--default"><div class="container"><div class="hero--category"><a aria-current="page" class="active" href="/guides/tutorial/">tutorial</a></div><h1 class="header_1mJE">How to setup rate limit on services</h1><div class="hero--subtitle">How to setup rate limit on services running on Qovery.</div><div class="tags_3AF9"><a class="badge badge--rounded badge--pink" href="/guides/tags/type-tutorial/">type: tutorial</a><a class="badge badge--rounded badge--primary" href="/guides/tags/technology-qovery/">technology: qovery</a></div></div></header><main class="container container--l container_1ncB"><aside class="sidebar_1pU0"><section class="avatar_1sJg"><div class="avatar avatar--lg avatar--vertical"><img class="avatar__photo avatar__photo--lg" src="https://github.com/benjaminch.png"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/benjaminch" target="_blank" rel="author">Benjamin Chastanier</a></div><small class="avatar__subtitle">Benjamin is a senior Backend Developer at <a href="https://www.qovery.com">Qovery</a>.</small></div></div></section><section class="table-of-contents tableOfContents_1eMQ"><div class="section"><div class="title">Stats</div><div class="text--secondary text--bold"><i class="feather icon-book"></i> 15 min read</div><div class="text--secondary text--bold"><i class="feather icon-clock"></i> Updated <time pubdate="pubdate" datetime="2025-01-09">Jan 9th, 2025</time></div></div><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#overview" class="contents__link">Overview</a></li><li><a href="#goal" class="contents__link">Goal</a></li><li><a href="#understand-nginx-rate-limiting-configuration" class="contents__link">Understand NGINX rate limiting configuration</a></li><li><a href="#initial-setup" class="contents__link">Initial setup</a></li><li><a href="#global-rate-limit" class="contents__link">Global rate limit</a></li><li><a href="#service-level-rate-limit" class="contents__link">Service level rate limit</a></li><li><a href="#service-rate-limit-per-custom-header" class="contents__link">Service rate limit per custom header</a></li><li><a href="#other-configuration-examples" class="contents__link">Other configuration examples</a><ul><li><a href="#custom-request-limit-status-http-code" class="contents__link">Custom request limit status HTTP code</a></li><li><a href="#limit-connections" class="contents__link">Limit connections</a></li></ul></li></ul></div></section></aside><div class="article_mCV7"><article><div class="markdown"><a aria-hidden="true" tabindex="-1" class="anchor" id="overview"></a><div class="alert alert--warning alert--icon" role="alert"><i class="feather icon-alert-triangle"></i>Changing NGINX snippets configuration is an advanced feature and can lead to misconfiguration. Please be careful when changing these settings as it might break the whole NGINX configuration and thus make impossible to reach your services.</div><p>Now that your service is up and running on Qovery, you might want to setup some rate limits to protect your service from abuse.
While we usually recommend to do it via third parties like Cloudlfare or similar because using such solutions, the traffic will be filtered out before reaching your workload hence not wasting your resources.
This guide will show you how to do that.</p><div class="alert alert--info alert--fill" role="alert"><p class="text--lg margin-bottom--sm" style="margin-top:-0.25em">Before you begin, this guide assumes the following:</p><ul><li>Your app is running on a Qovery managed cluster.</li></ul></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="goal"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#goal" title="Direct link to heading">#</a>Goal</h2><p>This tutorial will cover how to setup rate limit on your services by customizing Nginx configuration. Several options are possible:</p><ul><li><a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#global-rate-limit">Global rate limit</a></li><li><a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#global-rate-limit-per-custom-header">Global rate limit per custom header</a></li><li><a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#service-level-rate-limit">Service level rate limit</a></li><li><a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#custom-request-limit-status-http-code">Customize request limit HTTP status code</a></li><li><a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#limit-connections">Limit connection number</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="understand-nginx-rate-limiting-configuration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#understand-nginx-rate-limiting-configuration" title="Direct link to heading">#</a>Understand NGINX rate limiting configuration</h2><p>More information about how rate limit works on NGINX can be found on their blog in <a href="https://blog.nginx.org/blog/rate-limiting-nginx">this post</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="initial-setup"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#initial-setup" title="Direct link to heading">#</a>Initial setup</h2><div class="steps steps--h3"><ol><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="configure-service"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configure-service" title="Direct link to heading">#</a>Configure service</h4><p>I will use a basic container service <a href="https://hub.docker.com/r/jmalloc/echo-server">echo-server</a> setup with Qovery.
This service is listening on port 80.</p><p align="center"><img src="/img/nginx-rate-limit/service-initial-setup-qovery-screen.png" alt="Service initial setup in Qovery console"></p><p>To start with, this service don&#x27;t have any rate limit set, so everything will be accepted.</p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="for-demonstration-purpose-set-nginx-replicas-to-1"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#for-demonstration-purpose-set-nginx-replicas-to-1" title="Direct link to heading">#</a>For demonstration purpose: set nginx replicas to 1</h4><div class="alert alert--warning alert--icon" role="alert"><i class="feather icon-alert-triangle"></i>Rate limit will be set per nginx controller instances. Meaning, if you have more than 1 nginx instances, then those limits will be x2. You can configure the <a href="https://hub.qovery.com/docs/using-qovery/configuration/cluster-advanced-settings/#nginxhpamin_number_instances"> minimum </a> `nginx.hpa.min_number_instances` and <a href="https://hub.qovery.com/docs/using-qovery/configuration/cluster-advanced-settings/#nginxhpamax_number_instances"> maximum </a> `nginx.hpa.max_number_instances` number of instances in the Qovery console in cluster &gt; settings &gt; advanced-settings.</div><p>For this tutorial and to ease the demonstration, I am setting nginx controller instances to 1 (min = max = 1) in cluster advanced settings.
Please do not set this in production, as it will reduce the availability of your service.</p><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-replicas.png" alt="Set nginx replicas to 1 in cluster advanced settings"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="load-testing"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#load-testing" title="Direct link to heading">#</a>Load testing</h4><p>I will send couple requests against this service showing off there is no rate limit set (100 req/sec and 500 requests total).</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">❯ oha -q </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> https://p8080-za845ce06-z01d340ed-gtw.z77ccfcb8.slab.sh/</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Summary:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Success rate: </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total:        </span><span class="token number" style="color:#36acaa">4.9964</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Slowest:      </span><span class="token number" style="color:#36acaa">0.0275</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Fastest:      </span><span class="token number" style="color:#36acaa">0.0029</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Average:      </span><span class="token number" style="color:#36acaa">0.0052</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Requests/sec: </span><span class="token number" style="color:#36acaa">100.0720</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total data:   </span><span class="token number" style="color:#36acaa">229.00</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/request: </span><span class="token number" style="color:#36acaa">469</span><span class="token plain"> B</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/sec:     </span><span class="token number" style="color:#36acaa">45.83</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> histogram:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.003</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.005</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">432</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.008</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.010</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.013</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.015</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.018</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">39</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.020</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.023</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.025</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.028</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0032</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">25.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0034</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0038</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0043</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0150</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0163</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0211</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.90</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0275</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.99</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0275</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Details </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">average, fastest, slowest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS+dialup:   </span><span class="token number" style="color:#36acaa">0.0126</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0115</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0172</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS-lookup:   </span><span class="token number" style="color:#36acaa">0.0001</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0003</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Status code distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> responses</span></div></div></pre></div></div><p>As we can see, all requests ended up with <code>200</code> status code.</p></li></ol><div class="steps--feedback">How was it? Did this tutorial work?  <span class="button button--sm button--primary">Yes</span>  <a href="https://github.com/qovery/documentation/issues/new?body=The%20tutorial%20on%3A%0A%0Anull%0A%0AHere%27s%20what%20went%20wrong%3A%0A%0A%3C%21--%20Insert%20command%20output%20and%20details.%20Thank%20you%20for%20reporting%21%20%3A%29%20--%3E&amp;title=Tutorial%20on%20null%20failed" target="_blank" class="button button--sm button--primary">No</a></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="global-rate-limit"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#global-rate-limit" title="Direct link to heading">#</a>Global rate limit</h2><p>Setting a global rate limit that affects all matching requests from each IP address is useful for protecting your server from abuse while allowing legitimate traffic through.
This setting will set a global rate limit to all exposed services on the cluster.</p><div class="steps steps--h3"><ol><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="declare-the-global-rate-at-cluster-level"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#declare-the-global-rate-at-cluster-level" title="Direct link to heading">#</a>Declare the global rate at cluster level</h4><p>In order to set a global rate limit, we need to declare it at cluster level in cluster advanced settings <code>nginx.controller.http_snippet</code> (see <a href="https://hub.qovery.com/docs/using-qovery/configuration/cluster-advanced-settings/#nginxcontrollerhttp_snippet">documentation</a>).</p><p>Here&#x27;s nginx <code>nginx.controller.http_snippet</code> value we will set:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-nginx codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">limit_req_zone &quot;$server_name&quot; zone=global:10m rate=10r/s;</span></div></div></pre></div></div><strong>Details</strong><ul><li><code>limit_req_zone</code>: this is the NGINX directive that defines a shared memory zone for rate limiting</li><li><code>&quot;$server_name&quot;</code>: could be replaced with any constant value like <code>&quot;1&quot;</code>, the key just needs to be the same for all requests. You can also use <code>$http_x_forwarded_for</code> to rate limit based on the client IP address or any other custom headers, see <a aria-current="page" class="active" href="/guides/tutorial/how-to-setup-rate-limit-on-services#global-rate-limit-per-custom-header">custom rate limit key</a></li><li><code>zone=global:10m</code>: <code>global</code> is the name of the zone (you&#x27;ll reference this name in your location blocks), <code>10m</code> allocates 10 megabytes of shared memory for storing rate limiting states</li><li><code>rate=100r/s</code>: allows 100 requests per second, any requests above this rate will be delayed or rejected.</li></ul><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-set-global-rate-in-http-snippet.png" alt="Declare global rate limit at cluster level in cluster advanced settings"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="use-this-global-rate"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#use-this-global-rate" title="Direct link to heading">#</a>Use this global rate</h4><p>Now that our global rate is defined, let use it in our nginx configuration.</p><p>In order to do so, we need to declare this server snippet at cluster level in advanced setting <code>nginx.controller.server_snippet</code> (see <a href="https://hub.qovery.com/docs/using-qovery/configuration/cluster-advanced-settings/#nginxcontrollerserver_snippet">documentation</a>):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-nginx codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">location / {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    limit_req zone=global;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></pre></div></div><strong> Details </strong><ul><li><code>location /</code>: matches all HTTP requests to your server (the / path is the root and matches everything)</li><li><code>limit_req zone=global</code>: applies the rate limiting rules from the zone named <code>&quot;global&quot;</code> that we defined earlier. By default with this basic syntax, it will: not allow any bursting, reject excess requests with a 503 error, use <code>&quot;leaky bucket&quot;</code> algorithm for request processing</li></ul><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-set-global-rate-in-server-snippet.png" alt="Make use of global rate limit at cluster level in cluster advanced settings"></p><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i>However, this basic configuration can be quite strict. You can make it more forgiving by adding parameters: `burst=20 nodelay;` to the `limit_req` directive. This will allow the server to handle 20 requests in a burst, and not delay requests when the rate limit is exceeded.</div></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="deploy-your-cluster"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploy-your-cluster" title="Direct link to heading">#</a>Deploy your cluster</h4><p>You can now deploy your cluster with the new settings.</p><p align="center"><img src="/img/nginx-rate-limit/deploy-cluster-after-advanced-settings-changes.png" alt="Deploy cluster after advanced settings changes"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="testing-the-global-rate-limit"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#testing-the-global-rate-limit" title="Direct link to heading">#</a>Testing the global rate limit</h4><p>Let&#x27;s test our setup, by sending 100 requests per second for 500 requests total.
We should see that some requests are rejected with a 503 status code.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">❯ oha -q </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> https://p8080-za845ce06-z01d340ed-gtw.z77ccfcb8.slab.sh/</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ohaSummary:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Success rate: </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total:        </span><span class="token number" style="color:#36acaa">4.9966</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Slowest:      </span><span class="token number" style="color:#36acaa">0.0405</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Fastest:      </span><span class="token number" style="color:#36acaa">0.0024</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Average:      </span><span class="token number" style="color:#36acaa">0.0049</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Requests/sec: </span><span class="token number" style="color:#36acaa">100.0674</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total data:   </span><span class="token number" style="color:#36acaa">105.85</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/request: </span><span class="token number" style="color:#36acaa">216</span><span class="token plain"> B</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/sec:     </span><span class="token number" style="color:#36acaa">21.18</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> histogram:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.002</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.006</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">439</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.010</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.014</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.018</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">35</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.021</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.025</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.029</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.033</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.037</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.041</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0028</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">25.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0030</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0032</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0035</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0145</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0167</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0253</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.90</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0405</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.99</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0405</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Details </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">average, fastest, slowest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS+dialup:   </span><span class="token number" style="color:#36acaa">0.0141</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0113</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0264</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS-lookup:   </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0005</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Status code distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">503</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">452</span><span class="token plain"> responses</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> responses</span></div></div></pre></div></div><p>We do see a total of 500 requests sent over 5 seconds (100 req/sec) with 452 requests rejected with a <code>503</code> status code.
Doing the maths 48 requests were accepted with <code>200</code> status code (48 / 5 = 9.6 req/sec) which matches the limit we set: 10 req/sec.</p><p>One quick look at NGINX logs in our service logs, we can see a message for those rejected requests:</p><p align="center"><img src="/img/nginx-rate-limit/nginx-logs-rejecting-requests-with-global-rate.png" alt="NGINX logs showing requests rejections from global rate"></p></li></ol><div class="steps--feedback">How was it? Did this tutorial work?  <span class="button button--sm button--primary">Yes</span>  <a href="https://github.com/qovery/documentation/issues/new?body=The%20tutorial%20on%3A%0A%0Anull%0A%0AHere%27s%20what%20went%20wrong%3A%0A%0A%3C%21--%20Insert%20command%20output%20and%20details.%20Thank%20you%20for%20reporting%21%20%3A%29%20--%3E&amp;title=Tutorial%20on%20null%20failed" target="_blank" class="button button--sm button--primary">No</a></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="service-level-rate-limit"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#service-level-rate-limit" title="Direct link to heading">#</a>Service level rate limit</h2><p>You can also set rate limits at the service level, which can be useful if you want to have different rate limits for different services.</p><p>The configuration described below will limit the number of requests per second from an IP address (it&#x27;s not global to the service).</p><div class="steps steps--h3"><ol><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="set-rate-limit-in-service-advanced-settings"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#set-rate-limit-in-service-advanced-settings" title="Direct link to heading">#</a>Set rate limit in service advanced settings</h4><p>Go to your service advanced settings and set those two settings:</p><ul><li><code>network.ingress.nginx_limit_rps</code>: the rate limit in requests per second you want to set for your service (see <a href="https://hub.qovery.com/docs/using-qovery/configuration/advanced-settings/#networkingress-nginx_limit_rps">documentation</a>)</li><li><code>network.ingress.nginx_limit_rpm</code>: the rate limit in requests per minute you want to set for your service (see <a href="https://hub.qovery.com/docs/using-qovery/configuration/advanced-settings/#networkingress-nginx_limit_rpm">documentation</a>)</li><li><code>network.ingress.nginx_limit_burst_multiplier</code>: the burst limit multiplier in requests for your service (default is 5)  (see <a href="https://hub.qovery.com/docs/using-qovery/configuration/advanced-settings/#networkingress-nginx_limit_burst_multiplier">documentation</a>)</li></ul><p>For this example, I will set a rate limit of 10 requests per minute with a burst limit of 2x.</p><p>Using those</p><p align="center"><img src="/img/nginx-rate-limit/service-advanced-settings-set-limit-rpm-and-burst.png" alt="Service advanced settings to set request limit per minute and burst"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="deploy-your-service"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploy-your-service" title="Direct link to heading">#</a>Deploy your service</h4><p>Deploy your service with the new settings.</p><p align="center"><img src="/img/nginx-rate-limit/deploy-service.png" alt="Deploy service"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="testing-the-service-level-rate-limit"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#testing-the-service-level-rate-limit" title="Direct link to heading">#</a>Testing the service level rate limit</h4><p>Let&#x27;s test our setup, by sending 100 requests per second for 500 requests total.
We should see that some requests are rejected with a 503 status code.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">❯ oha -q </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> https://p8080-za845ce06-z417ab7bf-gtw.z77ccfcb8.slab.sh/</span></div><div class="token-line" style="color:#393A34"><span class="token plain">ohaSummary:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Success rate: </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total:        </span><span class="token number" style="color:#36acaa">5.0009</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Slowest:      </span><span class="token number" style="color:#36acaa">0.0705</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Fastest:      </span><span class="token number" style="color:#36acaa">0.0025</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Average:      </span><span class="token number" style="color:#36acaa">0.0062</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Requests/sec: </span><span class="token number" style="color:#36acaa">99.9827</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total data:   </span><span class="token number" style="color:#36acaa">98.52</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/request: </span><span class="token number" style="color:#36acaa">201</span><span class="token plain"> B</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/sec:     </span><span class="token number" style="color:#36acaa">19.70</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> histogram:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.002</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.009</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">449</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.016</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.023</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.030</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.036</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.043</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.050</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.057</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.064</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.070</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0029</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">25.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0031</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0033</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0037</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0145</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0263</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0578</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.90</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0705</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.99</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0705</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Details </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">average, fastest, slowest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS+dialup:   </span><span class="token number" style="color:#36acaa">0.0223</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0114</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0511</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS-lookup:   </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0001</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Status code distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">503</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">479</span><span class="token plain"> responses</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> responses</span></div></div></pre></div></div><p>We do see a total of 500 requests sent over 5 seconds (100 req/sec) with 479 requests rejected with a <code>503</code> status code.
Doing the maths 21 requests were accepted with <code>200</code> status code which matches the limit we set: 10 req/min with x2 burst multiplier.</p><p>One quick look at NGINX logs in our service logs, we can see a message for those rejected requests:</p><p align="center"><img src="/img/nginx-rate-limit/nginx-logs-rejecting-requests-with-service-rate.png" alt="NGINX logs showing requests rejections from global rate"></p><p>When you set both <code>network.ingress. nginx_limit_rpm</code> (rate per minute) and <code>network.ingress. nginx_limit_rps</code> (rate per second) annotations on an Nginx ingress, both rate limits will be enforced simultaneously. This means that traffic will be restricted based on whichever limit is hit first.
For example, if you set:</p><ul><li><code>network.ingress.nginx_limit_rpm</code>: 300</li><li><code>network.ingress.nginx_limit_rps</code>: 10</li></ul><p>This configuration would mean:</p><ul><li>No more than 300 requests allowed per minute</li><li>No more than 10 requests allowed per second</li></ul><p>In practice, the <code>network.ingress. nginx_limit_rps</code> often becomes the more restrictive limit. In the example above, while <code>network.ingress. nginx_limit_rpm</code> allows for 300 requests per minute (averaging to 5 requests per second), the <code>network.ingress. nginx_limit_rps</code> setting would block any burst over 10 requests in a single second, even if the total requests per minute is well below 300.</p></li></ol><div class="steps--feedback">How was it? Did this tutorial work?  <span class="button button--sm button--primary">Yes</span>  <a href="https://github.com/qovery/documentation/issues/new?body=The%20tutorial%20on%3A%0A%0Anull%0A%0AHere%27s%20what%20went%20wrong%3A%0A%0A%3C%21--%20Insert%20command%20output%20and%20details.%20Thank%20you%20for%20reporting%21%20%3A%29%20--%3E&amp;title=Tutorial%20on%20null%20failed" target="_blank" class="button button--sm button--primary">No</a></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="service-rate-limit-per-custom-header"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#service-rate-limit-per-custom-header" title="Direct link to heading">#</a>Service rate limit per custom header</h2><p>So far, we&#x27;ve created rate limit on server name or client address IP, but you can also create rate limit based on custom headers.</p><p>This configuration requires to declare a rate limit at cluster level and then update service configurartion to use it.</p><div class="steps steps--h3"><ol><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="define-this-rate-limiter"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#define-this-rate-limiter" title="Direct link to heading">#</a>Define this rate limiter</h4><p>Go to cluster advanced settings, and declare this new rate limiter by setting <code>nginx.controller.http_snippet</code> (see <a href="">documentation</a>) with the following value (if any configuration is already set as in the example below, you can just append it at the end):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-nginx codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">map $http_x_qovery_api_key $limit_key {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    default $http_x_qovery_api_key;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    &quot;&quot; &quot;anonymous&quot;;  # Fallback for missing or empty key</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">limit_req_zone $limit_key zone=qovery_api_limit:10m rate=5r/s;</span></div></div></pre></div></div><strong> Details </strong>- `map`: directive creates a variable `$limit_key` based on the value of the `$http_x_qovery_api_key` header - `$http_x_qovery_api_key`: is the incoming HTTP header that contains the API key for the client making the request<p>If <code>$http_x_qovery_api_key</code> is present and non-empty, <code>$limit_key</code> will be set to the value of <code>$http_x_qovery_api_key</code>.
If <code>$http_x_qovery_api_key</code> is missing or empty (&quot;&quot;), <code>$limit_key</code> is set to <code>&quot;anonymous&quot;</code>.</p><p>This ensures that requests without an API key are handled differently (e.g., rate-limited as anonymous users).</p><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-set-custom-header-rate-in-http-snippet.png" alt="Cluster settings custom header rate limiter"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="make-use-of-this-rate-limiter-at-service-level"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#make-use-of-this-rate-limiter-at-service-level" title="Direct link to heading">#</a>Make use of this rate limiter at service level</h4><p>Go to your service advanced settings and set <code>network.ingress.nginx_controller_configuration_snippet</code> with the following:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-nginx codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">limit_req zone=qovery_api_limit burst=2 nodelay;</span></div></div></pre></div></div><p>In this example, we have set a burst of <code>2</code> but it&#x27;s not mandatory, you can set it to fit best to your use case (checkout <a href="https://blog.nginx.org/blog/rate-limiting-nginx">this documentation</a> chapter <code>Handling bursts</code> to understand better burst).
It allows a small burst of requests beyond the defined rate before enforcing the rate limit.
Normally, the <code>rate=5r/s</code> setting in the <code>limit_req_zone</code> configuration allows up to 5 requests per second per <code>$limit_key</code>.</p><ul><li><code>burst=2</code> setting allows up to 2 extra requests to pass through immediately, even if the rate limit has been exceeded, but only for short bursts.</li><li>`nodelay`` disables queuing of excess requests, without nodelay, excess requests would be queued and served later, respecting the rate limit.</li></ul><p align="center"><img src="/img/nginx-rate-limit/service-advanced-settings-set-customer-header-rate-limiter-in-configuration-snippet.png" alt="Service settins custom header rate limiter"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="deploy-your-service-1"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploy-your-service-1" title="Direct link to heading">#</a>Deploy your service</h4><p>Deploy your service with the new settings.</p><p align="center"><img src="/img/nginx-rate-limit/deploy-service-with-custom-header-rate-limiter.png" alt="Deploy service with custom header rate limiter"></p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="testing-the-service-level-rate-limit-1"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#testing-the-service-level-rate-limit-1" title="Direct link to heading">#</a>Testing the service level rate limit</h4><p>Let&#x27;s test our setup, by sending 100 requests per second for 500 requests total.
We should see that some requests are rejected with a 503 status code.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">❯ oha -q </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> -n </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&quot;X-QOVERY-API-KEY: benjamin&quot;</span><span class="token plain"> https://p8080-za845ce06-z82b5bc64-gtw.z77ccfcb8.slab.sh/</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Summary:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Success rate: </span><span class="token number" style="color:#36acaa">100.00</span><span class="token plain">%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total:        </span><span class="token number" style="color:#36acaa">4.9952</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Slowest:      </span><span class="token number" style="color:#36acaa">0.0474</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Fastest:      </span><span class="token number" style="color:#36acaa">0.0025</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Average:      </span><span class="token number" style="color:#36acaa">0.0050</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Requests/sec: </span><span class="token number" style="color:#36acaa">100.0959</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total data:   </span><span class="token number" style="color:#36acaa">101.40</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/request: </span><span class="token number" style="color:#36acaa">207</span><span class="token plain"> B</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/sec:     </span><span class="token number" style="color:#36acaa">20.30</span><span class="token plain"> KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> histogram:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.002</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.007</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">447</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.011</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.016</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.020</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.025</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.029</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.034</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.038</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.043</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0.047</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">10.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0028</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">25.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0031</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">50.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0032</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">75.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0036</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">90.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0147</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">95.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0183</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.00</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0310</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.90</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0474</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">99.99</span><span class="token plain">% </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0474</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Details </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">average, fastest, slowest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS+dialup:   </span><span class="token number" style="color:#36acaa">0.0160</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0117</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0338</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS-lookup:   </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0000</span><span class="token plain"> secs, </span><span class="token number" style="color:#36acaa">0.0001</span><span class="token plain"> secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Status code distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">503</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">473</span><span class="token plain"> responses</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> responses</span></div></div></pre></div></div><p>We do see a total of 500 requests sent over 5 seconds (100 req/sec) with 473 requests rejected with a <code>503</code> status code.
Doing the maths 27 requests were accepted with <code>200</code> status code which matches the limit we set: 5.4 req/seq with two requests burst.</p><p>One quick look at NGINX logs in our service logs, we can see a message for those rejected requests:</p><p align="center"><img src="/img/nginx-rate-limit/nginx-logs-rejecting-requests-with-custom-header-in-service-logs.png" alt="NGINX logs showing requests rejections from custom header rate limit in service logs"></p><p>Looking at raw NGINX logs, we do see the name of the rate limiter rejecting those requests:</p><p align="center"><img src="/img/nginx-rate-limit/nginx-logs-rejecting-requests-with-custom-header.png" alt="NGINX logs showing requests rejections from custom header rate limit"></p></li></ol><div class="steps--feedback">How was it? Did this tutorial work?  <span class="button button--sm button--primary">Yes</span>  <a href="https://github.com/qovery/documentation/issues/new?body=The%20tutorial%20on%3A%0A%0Anull%0A%0AHere%27s%20what%20went%20wrong%3A%0A%0A%3C%21--%20Insert%20command%20output%20and%20details.%20Thank%20you%20for%20reporting%21%20%3A%29%20--%3E&amp;title=Tutorial%20on%20null%20failed" target="_blank" class="button button--sm button--primary">No</a></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="other-configuration-examples"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#other-configuration-examples" title="Direct link to heading">#</a>Other configuration examples</h2><p>In this section, you will find couple other configurations examples (non exhaustive) you can set.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="custom-request-limit-status-http-code"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#custom-request-limit-status-http-code" title="Direct link to heading">#</a>Custom request limit status HTTP code</h3><p>While NGINX defaults to <code>503</code> HTTP Status code when rejecting requests, you can change this default by setting <code>nginx.controller.limit_request_status_code</code> in cluster advanced settings.
For example, we usually use <code>429</code>.</p><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-custom-limit-http-status.png" alt="Custom http status code for limit in cluster advanced settings"></p><p>For any rate limited request, NGINX will now returns an HTTP <code>429</code> status code.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-nginx codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">oha -q 100 -n 500 -H &quot;X-QOVERY-API-KEY: benjamin&quot; https://p8080-za845ce06-z82b5bc64-gtw.z77ccfcb8.slab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">.sh/</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Summary:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Success rate: 100.00%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total:        5.0001 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Slowest:      0.0616 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Fastest:      0.0052 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Average:      0.0102 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Requests/sec: 99.9981</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Total data:   88.46 KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/request: 181 B</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  Size/sec:     17.69 KiB</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response time histogram:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.005 [1]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.011 [438] |■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.017 [10]  |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.022 [1]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.028 [0]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.033 [15]  |■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.039 [21]  |■</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.045 [4]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.050 [6]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.056 [1]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  0.062 [3]   |</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Response time distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  10.00% in 0.0062 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  25.00% in 0.0065 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  50.00% in 0.0069 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  75.00% in 0.0076 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  90.00% in 0.0278 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  95.00% in 0.0353 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  99.00% in 0.0501 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  99.90% in 0.0616 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  99.99% in 0.0616 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Details (average, fastest, slowest):</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS+dialup:   0.0282 secs, 0.0206 secs, 0.0537 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  DNS-lookup:   0.0000 secs, 0.0000 secs, 0.0001 secs</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Status code distribution:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [429] 473 responses</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  [200] 27 responses</span></div></div></pre></div></div><p>We can see <code>429</code> status code returned, same goes when looking at NGINX logs:</p><p align="center"><img src="/img/nginx-rate-limit/cluster-advanced-settings-custom-limit-http-status-logs.png" alt="NGINX logs showing requests rejections with custom http status code"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="limit-connections"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#limit-connections" title="Direct link to heading">#</a>Limit connections</h3><p>You might want to limit the number of concurrent connections allowed from a single IP address.
To do so, you can set the <code>network.ingress.nginx_limit_connections</code> advanced setting at service level.</p></div></article></div></main></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><p>Qovery is a DevOps Automation Platform Helping 200+ Organizations To Ship Faster and Eliminate DevOps Hiring Needs.</p></div><div><a href="https://github.com/qovery" target="_blank"><i class="feather icon-github" alt="Qovery&#x27;s Github Repo"></i></a>    <a href="https://www.linkedin.com/company/qovery/" target="_blank"><i class="feather icon-rss" alt="Qovery&#x27;s Linkedin"></i></a>    <a href="https://twitter.com/qovery_" target="_blank"><i class="feather icon-twitter" alt="Qovery&#x27;s Twitter"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">Resources</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides">Guides</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides/tutorial">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/guides/engineering">Engineering</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/pricing" href="https://www.qovery.com/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/enterprise" href="https://www.qovery.com/enterprise">Enterprise</a></li><li class="footer__item"><a class="footer__link-item" to="https://api-doc.qovery.com" href="https://api-doc.qovery.com">API</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery" href="https://github.com/Qovery">Github</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://community.qovery.com" href="https://community.qovery.com">Forum</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/community-call" href="https://www.qovery.com/community-call">Community call</a></li><li class="footer__item"><a class="footer__link-item" to="https://shop.qovery.com" href="https://shop.qovery.com">Goodies</a></li><li class="footer__item"><a class="footer__link-item" to="https://roadmap.qovery.com" href="https://roadmap.qovery.com">Roadmap</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery/replibyte" href="https://github.com/Qovery/replibyte">Replibyte</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/blog" href="https://www.qovery.com/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://jobs.qovery.com" href="https://jobs.qovery.com">Jobs</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/team" href="https://www.qovery.com/team">Team</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/investors" href="https://www.qovery.com/investors">Investors</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/contact" href="https://www.qovery.com/contact">Contact</a></li></ul></div></div><div class="text--center"><small>© 2025 DESIGNED BY QOVERY | PROUD SILVER MEMBER OF CNCF AND LINUX FOUNDATION | QOVERY BY BIRDSIGHT - ALL RIGHTS RESERVED</small><br></div></div></footer>
</div>

<script src="/styles.255c8fd1.js"></script>

<script src="/runtime~main.a03f576a.js"></script>

<script src="/main.7be101da.js"></script>

<script src="/1.385570ab.js"></script>

<script src="/2.91632de6.js"></script>

<script src="/3.ac200c48.js"></script>

<script src="/1c13b173.a1d42003.js"></script>

<script src="/58cf8c02.3058a95c.js"></script>


</body>
</html>
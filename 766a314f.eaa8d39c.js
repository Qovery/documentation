/*! For license information please see 766a314f.eaa8d39c.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[149],{300:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return u}));var r=n(1),o=n(9),a=(n(0),n(475)),i=(n(474),n(482),n(479),{last_modified_on:"2025-02-04",$schema:"/.meta/.schemas/guides.json",title:"Deploy a DaemonSet in a Karpenter context",description:"How to ensure your DaemonSet is well deployed when you are using Karpenter.",author_github:"https://github.com/acarranoqovery",tags:["type: tutorial","technology: qovery","installation_guide: aws"],hide_pagination:!0}),s={categories:[{name:"advanced",title:"Advanced",description:"Go beyond the basics, become a Qovery pro, and extract the full potential of Qovery.",permalink:"/guides/advanced"}],coverLabel:"Deploy a DaemonSet in a Karpenter context",description:"How to ensure your DaemonSet is well deployed when you are using Karpenter.",permalink:"/guides/advanced/deploy-daemonset-with-karpenter",readingTime:"4 min read",source:"@site/guides/advanced/deploy-daemonset-with-karpenter.md",tags:[{label:"type: tutorial",permalink:"/guides/tags/type-tutorial"},{label:"technology: qovery",permalink:"/guides/tags/technology-qovery"},{label:"installation_guide: aws",permalink:"/guides/tags/installation-guide-aws"}],title:"Deploy a DaemonSet in a Karpenter context",truncated:!1,prevItem:{title:"Customizing Preview URL with Qovery CLI",permalink:"/guides/tutorial/customizing-preview-url-with-qovery-cli"},nextItem:{title:"Deploy API Gateway",permalink:"/guides/advanced/deploy-api-gateway"}},l=[{value:"What is a DaemonSet?",id:"what-is-a-daemonset",children:[]},{value:"Priority classes",id:"priority-classes",children:[{value:"What is a PriorityClass?",id:"what-is-a-priorityclass",children:[]},{value:"Use PriorityClass built-in Helm Charts",id:"use-priorityclass-built-in-helm-charts",children:[]},{value:"Use Qovery&#39;s dedicated PriorityClass",id:"use-qoverys-dedicated-priorityclass",children:[]}]},{value:"Targeting all the nodes",id:"targeting-all-the-nodes",children:[{value:"Nodepool default taints",id:"nodepool-default-taints",children:[]},{value:"How to target every node",id:"how-to-target-every-node",children:[]}]}],c={rightToc:l};function u(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://karpenter.sh/"}),"Karpenter")," is a great way to cut your AWS bill. It provides a simple and flexible way to scale and optimize your resource consumption. "),Object(a.b)("p",null,"But when it comes to deploying DaemonSets, you need to take care of some specific configurations to ensure that your DaemonSet is well deployed. This guide will show you how to deploy a DaemonSet in a Karpenter context."),Object(a.b)("h2",{id:"what-is-a-daemonset"},"What is a DaemonSet?"),Object(a.b)("p",null,"A DaemonSet in Kubernetes is a specialized controller used to ensure that a copy of a particular pod runs on all nodes in a cluster. It is particularly useful for deploying background tasks or system-level services that need to run on every node, such as log collectors, monitoring agents, or network components."),Object(a.b)("p",null,"Key features of DaemonSets include:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Automatic Scheduling: When nodes are added to the cluster, the DaemonSet schedules the specified pod on the new nodes automatically."),Object(a.b)("li",{parentName:"ul"},"Cleanup: When nodes are removed, the DaemonSet cleans up the pods running on those nodes.")),Object(a.b)("p",null,"This makes DaemonSets a powerful tool for maintaining uniformity and reliability in the operation of essential services across a Kubernetes cluster."),Object(a.b)("h2",{id:"priority-classes"},"Priority classes"),Object(a.b)("p",null,"There is a ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/kubernetes-sigs/karpenter/issues/731"}),"known issue")," with Karpenter and DaemonSets when scaling nodes. DaemonSets ensure a copy of a pod runs on every node, consuming additional resources that Karpenter does not consider, leading to potential resource contention and under-provisioned nodes."),Object(a.b)("p",null,"This forces operators to over-provision their nodes, resulting in inefficient resource utilization and higher costs. While the Kubernetes community and Karpenter developers are working on solutions, users currently need to manually adjust resource allocations and monitor node utilization to mitigate these issues."),Object(a.b)("p",null,"A way to resolve this problem is to use a PriorityClass and attach it to the DaemonSet we are creating."),Object(a.b)("h3",{id:"what-is-a-priorityclass"},"What is a PriorityClass?"),Object(a.b)("p",null,"A PriorityClass in Kubernetes is a resource used to assign priority levels to pods. It helps the Kubernetes scheduler make decisions during resource contention by determining which pods should be scheduled first or evicted in case of resource shortages."),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Pods with higher priorities are scheduled before those with lower priorities."),Object(a.b)("li",{parentName:"ul"},"During resource shortages, lower-priority pods may be preempted (evicted) to free up resources for higher-priority pods.")),Object(a.b)("p",null,"This ensures that critical workloads have the resources they need to run effectively."),Object(a.b)("h3",{id:"use-priorityclass-built-in-helm-charts"},"Use PriorityClass built-in Helm Charts"),Object(a.b)("p",null,"Many Helm charts include built-in values to automatically create and configure PriorityClasses. We have examples in our documentation:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://hub.qovery.com/guides/tutorial/kubernetes-observability-and-monitoring-with-datadog/"}),"Kubernetes observability and monitoring with Datadog\n")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://hub.qovery.com/guides/tutorial/deploy-jupyterhub-qovery/"}),"Deploy JupyterHub using Helm\n"))),Object(a.b)("h3",{id:"use-qoverys-dedicated-priorityclass"},"Use Qovery's dedicated PriorityClass"),Object(a.b)("p",null,"When deploying Qovery on a cluster, a dedicated PriorityClass named ",Object(a.b)("inlineCode",{parentName:"p"},"qovery-standard-priority")," is created automatically.\nYou can use this PriorityClass when deploying a new Helm chart or DaemonSet to ensure that DaemonSets deploy correctly, even during resource contention."),Object(a.b)("h2",{id:"targeting-all-the-nodes"},"Targeting all the nodes"),Object(a.b)("p",null,"When deploying a DaemonSet, you can use taints and affinities to control where the DaemonSet pods are scheduled. This can help you ensure that the DaemonSet pods are deployed only on nodes that are interesting for you (for monitoring, logging etc..)."),Object(a.b)("h3",{id:"nodepool-default-taints"},"Nodepool default taints"),Object(a.b)("p",null,"By default, 2 nodepools are deployed with Karpenter: ",Object(a.b)("inlineCode",{parentName:"p"},"default")," and ",Object(a.b)("inlineCode",{parentName:"p"},"stable"),". On the ",Object(a.b)("inlineCode",{parentName:"p"},"stable")," nodepool, a taint has been defined to ensure that only pods having a toleration with the ",Object(a.b)("inlineCode",{parentName:"p"},"stable")," nodepool can be scheduled on it (key ",Object(a.b)("inlineCode",{parentName:"p"},"nodepool/stable"),")."),Object(a.b)("h3",{id:"how-to-target-every-node"},"How to target every node"),Object(a.b)("p",null,"To ensure that the DaemonSet pods are scheduled on every node, you can add a toleration to the DaemonSet pods that matches any taint. You also need to add an affinity to the DaemonSet pods to ensure that they are not scheduled on Fargate nodes."),Object(a.b)("p",null,"Here's an example of how you can do this with a helm chart:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml"}),"\n  tolerations:\n    - operator: Exists\n  affinity:\n    nodeAffinity:\n      requiredDuringSchedulingIgnoredDuringExecution:\n        nodeSelectorTerms:\n          - matchExpressions:\n            - key: eks.amazonaws.com/compute-type\n              operator: NotIn\n              values:\n                - fargate\n\n")))}u.isMDXComponent=!0},473:function(e,t,n){var r;!function(){"use strict";var n={}.hasOwnProperty;function o(){for(var e=[],t=0;t<arguments.length;t++){var r=arguments[t];if(r){var a=typeof r;if("string"===a||"number"===a)e.push(r);else if(Array.isArray(r)&&r.length){var i=o.apply(null,r);i&&e.push(i)}else if("object"===a)for(var s in r)n.call(r,s)&&r[s]&&e.push(s)}}return e.join(" ")}e.exports?(o.default=o,e.exports=o):void 0===(r=function(){return o}.apply(t,[]))||(e.exports=r)}()},474:function(e,t,n){"use strict";n(476);var r=n(0),o=n.n(r),a=n(473),i=n.n(a);n(132);t.a=function(e){var t=e.children,n=e.classNames,r=e.fill,a=e.icon,s=e.type,l=null;switch(s){case"danger":l="alert-triangle";break;case"success":l="check-circle";break;case"warning":l="alert-triangle";break;default:l="info"}return o.a.createElement("div",{className:i()(n,"alert","alert--"+s,{"alert--fill":r,"alert--icon":!1!==a}),role:"alert"},!1!==a&&o.a.createElement("i",{className:i()("feather","icon-"+(a||l))}),t)}},475:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return b}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),u=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s({},t,{},e)),n},d=function(e){var t=u(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},h=Object(r.forwardRef)((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),h=r,b=d["".concat(i,".").concat(h)]||d[h]||p[h]||a;return n?o.a.createElement(b,s({ref:t},c,{components:n})):o.a.createElement(b,s({ref:t},c))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},476:function(e,t,n){var r=n(12);r(r.P,"Array",{fill:n(477)}),n(74)("fill")},477:function(e,t,n){"use strict";var r=n(27),o=n(75),a=n(26);e.exports=function(e){for(var t=r(this),n=a(t.length),i=arguments.length,s=o(i>1?arguments[1]:void 0,n),l=i>2?arguments[2]:void 0,c=void 0===l?n:o(l,n);c>s;)t[s++]=e;return t}},478:function(e,t,n){var r=n(28).f,o=Function.prototype,a=/^\s*function ([^ (]*)/;"name"in o||n(10)&&r(o,"name",{configurable:!0,get:function(){try{return(""+this).match(a)[1]}catch(e){return""}}})},479:function(e,t,n){"use strict";n(478);var r=n(0),o=n.n(r),a=n(474);t.a=function(e){var t=e.children,n=e.name;return o.a.createElement(a.a,{type:"info",fill:!0,icon:!1,rounded:!0,className:"list--icons list--icons--arrow list--tight list--indent margin-bottom--lg"},o.a.createElement("p",{class:"text--lg margin-bottom--sm",style:{marginTop:"-0.25em"}},"Before you begin, this ",n||"page"," assumes the following:"),t)}},481:function(e,t,n){"use strict";var r=n(485),o=n(51);function a(e,t){return t.encode?t.strict?r(e):encodeURIComponent(e):e}t.extract=function(e){return e.split("?")[1]||""},t.parse=function(e,t){var n=function(e){var t;switch(e.arrayFormat){case"index":return function(e,n,r){t=/\[(\d*)\]$/.exec(e),e=e.replace(/\[\d*\]$/,""),t?(void 0===r[e]&&(r[e]={}),r[e][t[1]]=n):r[e]=n};case"bracket":return function(e,n,r){t=/(\[\])$/.exec(e),e=e.replace(/\[\]$/,""),t?void 0!==r[e]?r[e]=[].concat(r[e],n):r[e]=[n]:r[e]=n};default:return function(e,t,n){void 0!==n[e]?n[e]=[].concat(n[e],t):n[e]=t}}}(t=o({arrayFormat:"none"},t)),r=Object.create(null);return"string"!=typeof e?r:(e=e.trim().replace(/^(\?|#|&)/,""))?(e.split("&").forEach((function(e){var t=e.replace(/\+/g," ").split("="),o=t.shift(),a=t.length>0?t.join("="):void 0;a=void 0===a?null:decodeURIComponent(a),n(decodeURIComponent(o),a,r)})),Object.keys(r).sort().reduce((function(e,t){var n=r[t];return Boolean(n)&&"object"==typeof n&&!Array.isArray(n)?e[t]=function e(t){return Array.isArray(t)?t.sort():"object"==typeof t?e(Object.keys(t)).sort((function(e,t){return Number(e)-Number(t)})).map((function(e){return t[e]})):t}(n):e[t]=n,e}),Object.create(null))):r},t.stringify=function(e,t){var n=function(e){switch(e.arrayFormat){case"index":return function(t,n,r){return null===n?[a(t,e),"[",r,"]"].join(""):[a(t,e),"[",a(r,e),"]=",a(n,e)].join("")};case"bracket":return function(t,n){return null===n?a(t,e):[a(t,e),"[]=",a(n,e)].join("")};default:return function(t,n){return null===n?a(t,e):[a(t,e),"=",a(n,e)].join("")}}}(t=o({encode:!0,strict:!0,arrayFormat:"none"},t));return e?Object.keys(e).sort().map((function(r){var o=e[r];if(void 0===o)return"";if(null===o)return a(r,t);if(Array.isArray(o)){var i=[];return o.slice().forEach((function(e){void 0!==e&&i.push(n(r,e,i.length))})),i.join("&")}return a(r,t)+"="+a(o,t)})).filter((function(e){return e.length>0})).join("&"):""}},482:function(e,t,n){"use strict";var r=n(0),o=n.n(r),a=(n(473),n(481)),i=n.n(a);n(133);t.a=function(e){var t=e.children,n=e.headingDepth,a=e.hideFeedbackQuestion,s="undefined"!=typeof window?window.location:null,l={title:"Tutorial on "+s+" failed",body:"The tutorial on:\n\n"+s+"\n\nHere's what went wrong:\n\n\x3c!-- Insert command output and details. Thank you for reporting! :) --\x3e"},c="https://github.com/qovery/documentation/issues/new?"+i.a.stringify(l),u=Object(r.useState)(null),d=u[0],p=u[1];return o.a.createElement("div",{className:"steps steps--h"+n},t,!a&&!d&&o.a.createElement("div",{className:"steps--feedback"},"How was it? Did this tutorial work?\xa0\xa0",o.a.createElement("span",{className:"button button--sm button--primary",onClick:function(){return p("yes")}},"Yes"),"\xa0\xa0",o.a.createElement("a",{href:c,target:"_blank",className:"button button--sm button--primary"},"No")),"yes"==d&&o.a.createElement("div",{className:"steps--feedback steps--feedback--success"},"Thanks! If you're enjoying Qovery please consider ",o.a.createElement("a",{href:"https://github.com/qovery/documentation/",target:"_blank"},"starring our Github repo"),"."))}},485:function(e,t,n){"use strict";e.exports=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}))}}}]);
/*! For license information please see dfcfd2f3.c566bce9.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[285],{437:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return p})),n.d(t,"default",(function(){return m}));var r=n(1),o=n(9),a=(n(0),n(475)),i=n(474),l=n(479),s=(n(483),{last_modified_on:"2024-07-14",$schema:"/.meta/.schemas/guides.json",title:"GitOps with Qovery",description:"How to do GitOps with Qovery, GitHub and Terraform",author_github:"https://github.com/evoxmusic",tags:["type: tutorial","technology: qovery"],hide_pagination:!0}),c={categories:[{name:"tutorial",title:"Tutorial",description:"Additional step-by-step resources to leverage even more Qovery",permalink:"/guides/tutorial"}],coverLabel:"GitOps with Qovery",description:"How to do GitOps with Qovery, GitHub and Terraform",permalink:"/guides/tutorial/gitops-with-qovery",readingTime:"16 min read",source:"@site/guides/tutorial/gitops-with-qovery.md",tags:[{label:"type: tutorial",permalink:"/guides/tags/type-tutorial"},{label:"technology: qovery",permalink:"/guides/tags/technology-qovery"}],title:"GitOps with Qovery",truncated:!1,prevItem:{title:"Getting Started with Preview Environments on AWS",permalink:"/guides/tutorial/getting-started-with-preview-environments-on-aws-for-beginners"},nextItem:{title:"Grafana setup with Qovery",permalink:"/guides/tutorial/grafana-install"}},p=[{value:"Resources",id:"resources",children:[]},{value:"Terraform vs. YAML",id:"terraform-vs-yaml",children:[]},{value:"Step-by-step tutorial",id:"step-by-step-tutorial",children:[{value:"Step 1: Define the Terraform configuration",id:"step-1-define-the-terraform-configuration",children:[]},{value:"Step 2: Test the Terraform configuration",id:"step-2-test-the-terraform-configuration",children:[]},{value:"Step 3: Push the Terraform configuration to a GitHub repository",id:"step-3-push-the-terraform-configuration-to-a-github-repository",children:[]},{value:"Step 4: Use GitHub Actions to review and apply the Terraform configuration",id:"step-4-use-github-actions-to-review-and-apply-the-terraform-configuration",children:[]},{value:"Step 5: Check the Qovery console to see the resources created",id:"step-5-check-the-qovery-console-to-see-the-resources-created",children:[]}]},{value:"Frequently Asked Questions (FAQ)",id:"frequently-asked-questions-faq",children:[{value:"How to enforce GitOps?",id:"how-to-enforce-gitops",children:[]},{value:"How to &quot;GitOpsify&quot; an existing Qovery configuration?",id:"how-to-gitopsify-an-existing-qovery-configuration",children:[]},{value:"How to see configuration drifts?",id:"how-to-see-configuration-drifts",children:[]},{value:"How to debug?",id:"how-to-debug",children:[]},{value:"How to manage the Terraform state?",id:"how-to-manage-the-terraform-state",children:[]},{value:"How to connect to get Terraform Cloud state?",id:"how-to-connect-to-get-terraform-cloud-state",children:[]},{value:"How to integrate tests?",id:"how-to-integrate-tests",children:[]}]},{value:"Conclusion",id:"conclusion",children:[]}],u={rightToc:p};function m(e){var t=e.components,n=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"GitOps is a way to do Continuous Deployment (CD) with Git. It is a practice that allows you to manage your infrastructure and applications using Git repositories as the source of truth. In this tutorial, you will learn how to do GitOps with Qovery and the Qovery Terraform provider."),Object(a.b)("p",null,"Watch this short video to see the final result:"),Object(a.b)("div",{class:"video-container"},Object(a.b)("p",{align:"center"},Object(a.b)("iframe",{src:"https://www.loom.com/embed/f2b82cd32de8474fae7e8cba2d78dd29",width:"100%",height:"100%",frameborder:"0",webkitallowfullscreen:!0,mozallowfullscreen:!0,allowfullscreen:!0}))),Object(a.b)(l.a,{mdxType:"Assumptions"},Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"A ",Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://console.qovery.com/signup"}),"Qovery account")),Object(a.b)("li",{parentName:"ul"},"General knowledge of Terraform"))),Object(a.b)("p",null,"For our example we will do the following with Terraform:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Define all the Qovery resources in a Terraform configuration"),Object(a.b)("li",{parentName:"ol"},"Test it locally"),Object(a.b)("li",{parentName:"ol"},"Push the Terraform configuration to a GitHub repository"),Object(a.b)("li",{parentName:"ol"},"Use GitHub Actions (CI/CD) to review and apply the Terraform configuration"),Object(a.b)("li",{parentName:"ol"},"Check the Qovery console to see the resources created")),Object(a.b)("p",null,"So let's get started!"),Object(a.b)("h2",{id:"resources"},"Resources"),Object(a.b)("p",null,"Here are some resources you might need:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://console.qovery.com"}),"Qovery web console")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli"}),"Terraform CLI")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://registry.terraform.io/providers/Qovery/qovery/latest/docs"}),"Qovery Terraform Provider"))),Object(a.b)("h2",{id:"terraform-vs-yaml"},"Terraform vs. YAML"),Object(a.b)("p",null,"Just before we start, let's talk about why we use Terraform instead of YAML to manage the infrastructure in a GitOps way. Qovery provides an ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://registry.terraform.io/providers/Qovery/qovery/latest/docs"}),"official Terraform provider")," to manage your infrastructure. We did the choice to use Terraform instead of YAML for the following reasons:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Terraform is a well-known tool in the DevOps community"),Object(a.b)("li",{parentName:"ul"},"Terraform gets the state of the infrastructure, which is useful to know what is already created"),Object(a.b)("li",{parentName:"ul"},"Terraform helps to detect drifts between the desired state and the actual state")),Object(a.b)("p",null,"If you are not familiar with Terraform, you can learn more about it on the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.terraform.io/"}),"official website"),"."),Object(a.b)("h2",{id:"step-by-step-tutorial"},"Step-by-step tutorial"),Object(a.b)("p",null,"For this tutorial, we will create a simple Qovery application with a PostgreSQL database. This is just for demo purposes. You can adapt the Terraform configuration to your needs.\nThen We will use Terraform to define the resources and GitHub Actions to apply the Terraform configuration."),Object(a.b)(i.a,{type:"info",mdxType:"Alert"},Object(a.b)("p",null,"To enforce GitOps with Qovery, you can limit the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/docs/using-qovery/configuration/organization/members-rbac/"}),"permissions")," of your users to read-only in the Qovery console. This way, all the changes will be done via the Terraform configuration.")),Object(a.b)("h3",{id:"step-1-define-the-terraform-configuration"},"Step 1: Define the Terraform configuration"),Object(a.b)("p",null,"Create a new directory and add a ",Object(a.b)("inlineCode",{parentName:"p"},"variables.tf")," and a ",Object(a.b)("inlineCode",{parentName:"p"},"main.tf")," file with the following content:"),Object(a.b)(i.a,{type:"info",mdxType:"Alert"},Object(a.b)("p",null,Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/docs/using-qovery/configuration/environment/#terraform-exporter"}),"Export your Terraform configuration")," if you have already created your resources with the Qovery web console. ")),Object(a.b)("p",null,Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/evoxmusic/qovery-gitops/blob/main/variables.tf"}),"Read this example on GitHub")),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-hcl",metastring:'title="variables.tf"',title:'"variables.tf"'}),'variable "qovery_token" {\n  description = "Qovery API token"\n  type        = string\n}\n\nvariable "qovery_organization_id" {\n  description = "Qovery Organization ID"\n  type        = string\n}\n\nvariable "qovery_cluster_id" {\n  description = "My Qovery Test Cluster ID"\n  type        = string\n}\n')),Object(a.b)("p",null,Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/evoxmusic/qovery-gitops/blob/main/main.tf"}),"Read this example on GitHub")),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-hcl",metastring:'title="main.tf"',title:'"main.tf"'}),'terraform {\n   required_providers {\n      qovery = {\n         source = "qovery/qovery"\n      }\n   }\n}\n\nprovider "qovery" {\n   token = var.qovery_access_token\n}\n\nresource "qovery_project" "my_project" {\n   organization_id = var.qovery_organization_id\n   name            = "My TF Project"\n}\n\nresource "qovery_environment" "production" {\n   project_id = qovery_project.my_project.id\n   name       = "production"\n   mode       = "PRODUCTION"\n   cluster_id = var.qovery_cluster_id\n}\n\nresource "qovery_database" "my_database" {\n   environment_id = qovery_environment.production.id\n   name           = "My DB"\n   type           = "POSTGRESQL"\n   version        = "16"\n   mode           = "CONTAINER"\n   storage        = 10\n   accessibility  = "PRIVATE"\n}\n\nresource "qovery_application" "my_backend" {\n   environment_id = qovery_environment.production.id\n   name           = "My Backend"\n   cpu            = 250\n   memory         = 128\n   git_repository = {\n      url       = "https://github.com/evoxmusic/ShortMe-URL-Shortener.git"\n      branch    = "main"\n      root_path = "/"\n   }\n   build_mode      = "DOCKER"\n   dockerfile_path = "Dockerfile"\n   ports           = [\n      {\n         internal_port       = 5555\n         external_port       = 443\n         protocol            = "HTTP"\n         publicly_accessible = true\n         is_default          = true\n      }\n   ]\n   healthchecks = {\n      readiness_probe = {\n         type = {\n            http = {\n               port = 5555\n               scheme = "HTTP"\n               path = "/"\n            }\n         }\n         initial_delay_seconds = 30\n         period_seconds        = 10\n         timeout_seconds       = 10\n         success_threshold     = 1\n         failure_threshold     = 3\n      }\n      liveness_probe = {\n         type = {\n            http = {\n               port = 5555\n               scheme = "HTTP"\n               path = "/"\n            }\n         }\n         initial_delay_seconds = 30\n         period_seconds        = 10\n         timeout_seconds       = 10\n         success_threshold     = 1\n         failure_threshold     = 3\n      }\n   }\n   environment_variables = [\n      {\n         key   = "DATABASE_HOST"\n         value = qovery_database.my_database.internal_host\n      },\n      {\n         key   = "DATABASE_PORT"\n         value = qovery_database.my_database.port\n      },\n      {\n         key   = "DATABASE_USERNAME"\n         value = qovery_database.my_database.login\n      },\n      {\n         key   = "DATABASE_NAME"\n         value = "postgres"\n      },\n   ]\n   secrets = [\n      {\n         key   = "DATABASE_PASSWORD"\n         value = qovery_database.my_database.password\n      }\n   ]\n}\n\nresource "qovery_deployment" "my_deployment" {\n   environment_id = qovery_environment.production.id\n   desired_state  = "RUNNING"\n   version        = "a0282bb4-f5bb-44ed-882d-e067f92d105e"\n\n   depends_on = [\n      qovery_application.my_backend,\n      qovery_database.my_database,\n      qovery_environment.production,\n   ]\n}\n')),Object(a.b)("p",null,"My arborescence looks like this:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),"$ ls -lh\n\nPermissions Size User      Date Modified Name\n.rw-r--r--  2.8k xxx 11 Jul 10:28  main.tf\n.rw-r--r--   297 xxx 10 Jul 17:24  variables.tf\n")),Object(a.b)("h3",{id:"step-2-test-the-terraform-configuration"},"Step 2: Test the Terraform configuration"),Object(a.b)("h4",{id:"generate-a-qovery-token"},"Generate a Qovery token"),Object(a.b)("p",null,"To test your Terraform configuration, you first need to generate a Qovery token. You can do this by following the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/docs/using-qovery/configuration/organization/api-token/"}),"official documentation"),"."),Object(a.b)("h4",{id:"test-terraform-configuration-locally"},"Test Terraform configuration locally"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Download and install ",Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://developer.hashicorp.com/terraform/install"}),"Terraform CLI")),Object(a.b)("li",{parentName:"ol"},"Set environment variables ",Object(a.b)("ol",{parentName:"li"},Object(a.b)("li",{parentName:"ol"},"Qovery API Token: ",Object(a.b)("inlineCode",{parentName:"li"},"export TF_VAR_qovery_token=XXX")),Object(a.b)("li",{parentName:"ol"},"Qovery Organization ID: ",Object(a.b)("inlineCode",{parentName:"li"},"export TF_VAR_qovery_organization_id=XXX")),Object(a.b)("li",{parentName:"ol"},"Qovery Cluster ID: ",Object(a.b)("inlineCode",{parentName:"li"},"export TF_VAR_qovery_cluster_id=XXX")))),Object(a.b)("li",{parentName:"ol"},"Init Terraform modules: ",Object(a.b)("inlineCode",{parentName:"li"},"terraform init")),Object(a.b)("li",{parentName:"ol"},"Plan the Terraform configuration: ",Object(a.b)("inlineCode",{parentName:"li"},"terraform plan")),Object(a.b)("li",{parentName:"ol"},"Apply the Terraform configuration: ",Object(a.b)("inlineCode",{parentName:"li"},"terraform apply -auto-approve"))),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell",metastring:'title="Test Terraform locally"',title:'"Test',Terraform:!0,'locally"':!0}),"$ export TF_VAR_qovery_token=XXX TF_VAR_qovery_token=XXX TF_VAR_qovery_cluster_id=XXX\n\n$ terraform init && terraform apply -auto-approve\n")),Object(a.b)("p",null,"The output should show the resources created."),Object(a.b)("details",null,Object(a.b)("summary",null,"Example output"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell",metastring:'title="Terraform output"',title:'"Terraform','output"':!0}),'Terraform used the selected providers to generate the following execution plan. Resource actions are\nindicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  # qovery_application.my_backend will be created\n  + resource "qovery_application" "my_backend" {\n      + advanced_settings_json         = (known after apply)\n      + arguments                      = (known after apply)\n      + auto_deploy                    = (known after apply)\n      + auto_preview                   = false\n      + build_mode                     = "DOCKER"\n      + built_in_environment_variables = (known after apply)\n      + cpu                            = 250\n      + deployment_stage_id            = (known after apply)\n      + dockerfile_path                = "Dockerfile"\n      + environment_id                 = (known after apply)\n      + environment_variables          = [\n          + {\n              + id    = (known after apply)\n              + key   = "DATABASE_HOST"\n              + value = (known after apply)\n            },\n          + {\n              + id    = (known after apply)\n              + key   = "DATABASE_NAME"\n              + value = "postgres"\n            },\n          + {\n              + id    = (known after apply)\n              + key   = "DATABASE_PORT"\n              + value = (known after apply)\n            },\n          + {\n              + id    = (known after apply)\n              + key   = "DATABASE_USERNAME"\n              + value = (known after apply)\n            },\n        ]\n      + external_host                  = (known after apply)\n      + git_repository                 = {\n          + branch    = "main"\n          + root_path = "/"\n          + url       = "https://github.com/evoxmusic/ShortMe-URL-Shortener.git"\n        }\n      + healthchecks                   = {\n          + liveness_probe  = {\n              + failure_threshold     = 3\n              + initial_delay_seconds = 30\n              + period_seconds        = 10\n              + success_threshold     = 1\n              + timeout_seconds       = 10\n              + type                  = {\n                  + http = {\n                      + path   = "/"\n                      + port   = 5555\n                      + scheme = "HTTP"\n                    }\n                }\n            }\n          + readiness_probe = {\n              + failure_threshold     = 3\n              + initial_delay_seconds = 30\n              + period_seconds        = 10\n              + success_threshold     = 1\n              + timeout_seconds       = 10\n              + type                  = {\n                  + http = {\n                      + path   = "/"\n                      + port   = 5555\n                      + scheme = "HTTP"\n                    }\n                }\n            }\n        }\n      + id                             = (known after apply)\n      + internal_host                  = (known after apply)\n      + max_running_instances          = 1\n      + memory                         = 128\n      + min_running_instances          = 1\n      + name                           = "My Backend"\n      + ports                          = [\n          + {\n              + external_port       = 443\n              + id                  = (known after apply)\n              + internal_port       = 5555\n              + is_default          = true\n              + name                = (known after apply)\n              + protocol            = "HTTP"\n              + publicly_accessible = true\n            },\n        ]\n      + secrets                        = (sensitive value)\n    }\n\n  # qovery_database.my_database will be created\n  + resource "qovery_database" "my_database" {\n      + accessibility       = "PRIVATE"\n      + cpu                 = 250\n      + deployment_stage_id = (known after apply)\n      + environment_id      = (known after apply)\n      + external_host       = (known after apply)\n      + id                  = (known after apply)\n      + instance_type       = (known after apply)\n      + internal_host       = (known after apply)\n      + login               = (known after apply)\n      + memory              = 256\n      + mode                = "CONTAINER"\n      + name                = "My DB"\n      + password            = (known after apply)\n      + port                = (known after apply)\n      + storage             = 10\n      + type                = "POSTGRESQL"\n      + version             = "16"\n    }\n\n  # qovery_deployment.my_deployment will be created\n  + resource "qovery_deployment" "my_deployment" {\n      + desired_state  = "RUNNING"\n      + environment_id = (known after apply)\n      + id             = (known after apply)\n      + version        = "a0282bb4-f5bb-44ed-882d-e067f92d106e"\n    }\n\n  # qovery_environment.production will be created\n  + resource "qovery_environment" "production" {\n      + built_in_environment_variables = (known after apply)\n      + cluster_id                     = "809f9644-b3e4-400b-97fc-e2173d46a00e"\n      + id                             = (known after apply)\n      + mode                           = "PRODUCTION"\n      + name                           = "production"\n      + project_id                     = (known after apply)\n    }\n\n  # qovery_project.my_project will be created\n  + resource "qovery_project" "my_project" {\n      + built_in_environment_variables = (known after apply)\n      + description                    = (known after apply)\n      + id                             = (known after apply)\n      + name                           = "My TF Project"\n      + organization_id                = "141c07c8-0dd9-4623-983b-3fdd61867255"\n    }\n\nPlan: 5 to add, 0 to change, 0 to destroy.\nqovery_project.my_project: Creating...\nqovery_project.my_project: Creation complete after 1s [id=66ad165a-f7f8-4840-8519-8db11ae7d127]\nqovery_environment.production: Creating...\nqovery_environment.production: Creation complete after 1s [id=a51a7e66-af37-425a-92a7-c07b9f1752fc]\nqovery_database.my_database: Creating...\nqovery_database.my_database: Creation complete after 2s [id=454b5baa-1465-4383-a822-32f1511222a0]\nqovery_application.my_backend: Creating...\nqovery_application.my_backend: Creation complete after 3s [id=a4ff2488-ad6a-4218-9e52-68aa3ebdd059]\nqovery_deployment.my_deployment: Creating...\nqovery_deployment.my_deployment: Still creating... [10s elapsed]\nqovery_deployment.my_deployment: Still creating... [20s elapsed]\nqovery_deployment.my_deployment: Still creating... [30s elapsed]\nqovery_deployment.my_deployment: Still creating... [40s elapsed]\nqovery_deployment.my_deployment: Still creating... [50s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m0s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m10s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m20s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m30s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m40s elapsed]\nqovery_deployment.my_deployment: Still creating... [1m50s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m0s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m10s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m20s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m30s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m40s elapsed]\nqovery_deployment.my_deployment: Still creating... [2m50s elapsed]\nqovery_deployment.my_deployment: Still creating... [3m0s elapsed]\nqovery_deployment.my_deployment: Still creating... [3m10s elapsed]\nqovery_deployment.my_deployment: Still creating... [3m20s elapsed]\nqovery_deployment.my_deployment: Creation complete after 3m24s [id=84435485-eb50-4051-b91f-61f99985edf2]\n\nApply complete! Resources: 5 added, 0 changed, 0 destroyed.\n'))),Object(a.b)("p",null,"If you edit resources in the Terraform configuration, you can re-apply the changes with ",Object(a.b)("inlineCode",{parentName:"p"},"terraform apply -auto-approve"),". Note that for service resources, when you change the configuration, you need to redeploy them by updating the ",Object(a.b)("inlineCode",{parentName:"p"},"qovery_deployment.version")," UUID."),Object(a.b)(i.a,{type:"warning",mdxType:"Alert"},Object(a.b)("p",null,"Once you have tested your Terraform configuration locally, you must clean up the resources with ",Object(a.b)("inlineCode",{parentName:"p"},"terraform destroy -auto-approve")," since we will use our CI/CD tool to apply the Terraform configuration and a remote Terraform backend to store the state.")),Object(a.b)("h3",{id:"step-3-push-the-terraform-configuration-to-a-github-repository"},"Step 3: Push the Terraform configuration to a GitHub repository"),Object(a.b)("p",null,"Since we have tested the Terraform configuration locally, we can now push it to your Git repository. In my case, I will use GitHub."),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Create a Git repository"),Object(a.b)("li",{parentName:"ol"},"Commit and push the Terraform configuration to the repository")),Object(a.b)(i.a,{type:"warning",mdxType:"Alert"},Object(a.b)("p",null,"Make sure to add the ",Object(a.b)("inlineCode",{parentName:"p"},".terraform")," directory and other generated terraform metafiles to your ",Object(a.b)("inlineCode",{parentName:"p"},".gitignore")," file.")),Object(a.b)("p",null,"Here is a .gitignore you can use:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-gitignore",metastring:'title=".gitignore"',title:'".gitignore"'}),"# Local .terraform directories\n**/.terraform/*\n\n# .tfstate files\n*.tfstate\n*.tfstate.*\n\n# Crash log files\ncrash.log\ncrash.*.log\n\n# Exclude all .tfvars files, which are likely to contain sensitive data, such as\n# password, private keys, and other secrets. These should not be part of version \n# control as they are data points which are potentially sensitive and subject \n# to change depending on the environment.\n*.tfvars\n*.tfvars.json\n\n# Ignore override files as they are usually used to override resources locally and so\n# are not checked in\noverride.tf\noverride.tf.json\n*_override.tf\n*_override.tf.json\n\n# Include override files you do wish to add to version control using negated pattern\n# !example_override.tf\n\n# Include tfplan files to ignore the plan output of command: terraform plan -out=tfplan\n# example: *tfplan*\n\n# Ignore CLI configuration files\n.terraformrc\nterraform.rc\n")),Object(a.b)("h3",{id:"step-4-use-github-actions-to-review-and-apply-the-terraform-configuration"},"Step 4: Use GitHub Actions to review and apply the Terraform configuration"),Object(a.b)("p",null,"In my case, I will use:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://github.com/features/actions"}),"GitHub Actions")," as a CI tool to review and apply the Terraform."),Object(a.b)("li",{parentName:"ul"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"https://www.hashicorp.com/cloud"}),"Hashicorp Cloud Platform")," as a Terraform backend state. ")),Object(a.b)("p",null,"Note that you can use any CI/CD tool and Terraform backend you want."),Object(a.b)("p",null,Object(a.b)("em",{parentName:"p"},"This section is inspired by the official ",Object(a.b)("a",Object(r.a)({parentName:"em"},{href:"https://developer.hashicorp.com/terraform/tutorials/automation/github-actions"}),"Terraform GitHub Actions documentation"),".")),Object(a.b)("p",null,"Here is an example of a GitHub Actions workflow (",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/evoxmusic/qovery-gitops/blob/main/.github/workflows/terraform-plan.yml"}),"GitHub Link"),") when a Pull Request is created:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title=".github/workflows/terraform-plan.yml"',title:'".github/workflows/terraform-plan.yml"'}),'name: "Terraform Plan"\n\non:\n   pull_request:\n\nenv:\n   TF_CLOUD_ORGANIZATION: "YOUR-ORGANIZATION-HERE"\n   TF_API_TOKEN: "${{ secrets.TF_API_TOKEN }}"\n   TF_WORKSPACE: "YOUR-WORKSPACE-HERE"\n   CONFIG_DIRECTORY: "./"\n\njobs:\n   terraform:\n      name: "Terraform Plan"\n      runs-on: ubuntu-latest\n      permissions:\n         contents: read\n         pull-requests: write\n      steps:\n         - name: Checkout\n           uses: actions/checkout@v3\n\n         - name: Upload Configuration\n           uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.0.0\n           id: plan-upload\n           with:\n              workspace: ${{ env.TF_WORKSPACE }}\n              directory: ${{ env.CONFIG_DIRECTORY }}\n              speculative: true\n\n         - name: Create Plan Run\n           uses: hashicorp/tfc-workflows-github/actions/create-run@v1.0.0\n           id: plan-run\n           with:\n              workspace: ${{ env.TF_WORKSPACE }}\n              configuration_version: ${{ steps.plan-upload.outputs.configuration_version_id }}\n              plan_only: true\n\n         - name: Get Plan Output\n           uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.0.0\n           id: plan-output\n           with:\n              plan: ${{ fromJSON(steps.plan-run.outputs.payload).data.relationships.plan.data.id }}\n\n         - name: Update PR\n           uses: actions/github-script@v6\n           id: plan-comment\n           with:\n              github-token: ${{ secrets.GITHUB_TOKEN }}\n              script: |\n                 // 1. Retrieve existing bot comments for the PR\n                 const { data: comments } = await github.rest.issues.listComments({\n                   owner: context.repo.owner,\n                   repo: context.repo.repo,\n                   issue_number: context.issue.number,\n                 });\n                 const botComment = comments.find(comment => {\n                   return comment.user.type === \'Bot\' && comment.body.includes(\'Terraform Cloud Plan Output\')\n                 });\n                 const output = `#### Terraform Cloud Plan Output\n                    \\`\\`\\`\n                    Plan: ${{ steps.plan-output.outputs.add }} to add, ${{ steps.plan-output.outputs.change }} to change, ${{ steps.plan-output.outputs.destroy }} to destroy.\n                    \\`\\`\\`\n                    [Terraform Cloud Plan](${{ steps.plan-run.outputs.run_link }})\n                    `;\n                 // 3. Delete previous comment so PR timeline makes sense\n                 if (botComment) {\n                   github.rest.issues.deleteComment({\n                     owner: context.repo.owner,\n                     repo: context.repo.repo,\n                     comment_id: botComment.id,\n                   });\n                 }\n                 github.rest.issues.createComment({\n                   issue_number: context.issue.number,\n                   owner: context.repo.owner,\n                   repo: context.repo.repo,\n                   body: output\n                 });\n')),Object(a.b)("p",null,"When a Pull Request is created, the GitHub Actions workflow will run the Terraform plan and post the output in the PR comments. So you can ",Object(a.b)("strong",{parentName:"p"},"review the changes")," before merging the PR."),Object(a.b)("p",null,"Here is an example of a GitHub Actions workflow (",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/evoxmusic/qovery-gitops/blob/main/.github/workflows/terraform-plan.yml"}),"GitHub Link"),") when the PR is merged:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-yaml",metastring:'title=".github/workflows/terraform-apply.yml"',title:'".github/workflows/terraform-apply.yml"'}),'name: "Terraform Apply"\n\non:\n  push:\n    branches:\n      - main\n\nenv:\n  TF_CLOUD_ORGANIZATION: "YOUR-ORGANIZATION-HERE"\n  TF_API_TOKEN: "${{ secrets.TF_API_TOKEN }}"\n  TF_WORKSPACE: "YOUR-WORKSPACE-HERE"\n  CONFIG_DIRECTORY: "./"\n\njobs:\n  terraform:\n    name: "Terraform Apply"\n    runs-on: ubuntu-latest\n    permissions:\n      contents: read\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n\n      - name: Upload Configuration\n        uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.0.0\n        id: apply-upload\n        with:\n          workspace: ${{ env.TF_WORKSPACE }}\n          directory: ${{ env.CONFIG_DIRECTORY }}\n\n      - name: Create Apply Run\n        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.0.0\n        id: apply-run\n        with:\n          workspace: ${{ env.TF_WORKSPACE }}\n          configuration_version: ${{ steps.apply-upload.outputs.configuration_version_id }}\n\n      - name: Apply\n        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.0.0\n        if: fromJSON(steps.apply-run.outputs.payload).data.attributes.actions.IsConfirmable\n        id: apply\n        with:\n          run: ${{ steps.apply-run.outputs.run_id }}\n          comment: "Apply Run from GitHub Actions CI ${{ github.sha }}"\n')),Object(a.b)("p",null,"When the PR is merged on the main branch, the GitHub Actions workflow will apply the Terraform configuration."),Object(a.b)("h3",{id:"step-5-check-the-qovery-console-to-see-the-resources-created"},"Step 5: Check the Qovery console to see the resources created"),Object(a.b)("p",null,"After the GitHub Actions workflow is completed, you can check the Qovery console to see the resources created."),Object(a.b)("p",{align:"center"},Object(a.b)("img",{src:"/img/resources-created-with-terraform.jpg",alt:"Qovery resources created via Terraform in a GitOps way"})),Object(a.b)("p",null,"As you can see, you can manage your infrastructure and applications using Git repositories as the source of truth with Qovery and Terraform."),Object(a.b)("h2",{id:"frequently-asked-questions-faq"},"Frequently Asked Questions (FAQ)"),Object(a.b)("h3",{id:"how-to-enforce-gitops"},"How to enforce GitOps?"),Object(a.b)("p",null,"Here are the two things we recommend to enforce GitOps with Qovery:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"/docs/using-qovery/configuration/organization/members-rbac/"}),"Restrict permissions")," of your users to read-only in Qovery. So only the API Qovery Token used by Terraform will be able to create, update, or delete resources. "),Object(a.b)("li",{parentName:"ol"},"Turn off the ",Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"/docs/using-qovery/deployment/deploying-with-auto-deploy/"}),"application auto-deployment")," in Qovery. If you have linked apps via Git with Qovery, you can turn off the auto-deployment.")),Object(a.b)("p",null,"This way, all the changes will be done via the Terraform configuration."),Object(a.b)("h3",{id:"how-to-gitopsify-an-existing-qovery-configuration"},'How to "GitOpsify" an existing Qovery configuration?'),Object(a.b)("p",null,"To make your existing configuration GitOps compatible, you can follow these steps:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Export your existing Qovery configuration with the ",Object(a.b)("a",Object(r.a)({parentName:"li"},{href:"/docs/using-qovery/configuration/environment/#terraform-exporter"}),"Terraform exporter"),"."),Object(a.b)("li",{parentName:"ol"},"Edit your exported Terraform configuration."),Object(a.b)("li",{parentName:"ol"},"Test the Terraform configuration locally."),Object(a.b)("li",{parentName:"ol"},"Push the Terraform configuration to a Git repository.")),Object(a.b)("h3",{id:"how-to-see-configuration-drifts"},"How to see configuration drifts?"),Object(a.b)("p",null,"Terraform helps to detect drifts between the desired state and the actual state. When you will create a Pull Request, the GitHub Actions workflow will run the Terraform plan and post the output in the PR comments. So you can review the changes before merging the PR. "),Object(a.b)("p",null,"You can also use the ",Object(a.b)("inlineCode",{parentName:"p"},"terraform plan")," locally command to see the changes that will be applied."),Object(a.b)("h3",{id:"how-to-debug"},"How to debug?"),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Terraform logs"),":\nLet's say you have a problem with the Terraform configuration. You can debug it by checking the Terraform logs in the GitHub Actions workflow. You can also use the Terraform CLI to debug the configuration locally."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Application logs"),":\nIf the problem is not in the Terraform configuration, you can check the Qovery web console to see the resources created and the associated ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/docs/using-qovery/deployment/logs/"}),"logs"),"."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"CI/CD logs"),":\nYou can check the GitHub Actions logs to see the Terraform plan and apply outputs."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Qovery logs"),":\nYou can check the Qovery ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/docs/using-qovery/audit-logs/"}),"Audit Logs")," to see the changes made by the Terraform configuration."),Object(a.b)("h3",{id:"how-to-manage-the-terraform-state"},"How to manage the Terraform state?"),Object(a.b)("p",null,"Like in the example above, we recommend using a remote Terraform backend to store the state. This way, you can share the state between your team members and have a history of the changes. You can use the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://www.hashicorp.com/cloud"}),"Hashicorp Cloud Platform")," or any other Terraform backend you want."),Object(a.b)("h3",{id:"how-to-connect-to-get-terraform-cloud-state"},"How to connect to get Terraform Cloud state?"),Object(a.b)("p",null,"Create a ",Object(a.b)("inlineCode",{parentName:"p"},"backend.tf")," file in your Terraform configuration with the following content:"),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-hcl",metastring:'title="backend.tf"',title:'"backend.tf"'}),'terraform {\n   backend "remote" {\n      hostname     = "app.terraform.io"\n      organization = "Qovery"\n      workspaces {\n         name = "qovery-gitops"\n      }\n   }\n}\n')),Object(a.b)("p",null,"Refer to ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://support.hashicorp.com/hc/en-us/articles/360001151948-Migrate-Workspace-State-Using-Terraform-State-Push-Pull"}),"this documentation")),Object(a.b)("h3",{id:"how-to-integrate-tests"},"How to integrate tests?"),Object(a.b)("p",null,"You can use the Qovery API to get the resources URLs and integrate them in your CI/CD. For example, you can get the URL of the application and use it in your tests. Look at this guide on ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"/guides/tutorial/build-e2e-testing-ephemeral-environments/"}),"how to run E2E tests with Qovery and GitHub Actions"),"."),Object(a.b)("h2",{id:"conclusion"},"Conclusion"),Object(a.b)("p",null,"In this tutorial, you learned how to do GitOps with Qovery and the Qovery Terraform provider. You defined all the Qovery resources in a Terraform configuration, tested it locally, pushed it to a GitHub repository, used GitHub Actions to review and apply the Terraform configuration, and checked the Qovery console to see the resources created."),Object(a.b)("p",null,"If you have any questions or need help, feel free to ask in the ",Object(a.b)("a",Object(r.a)({parentName:"p"},{href:"https://discuss.qovery.com/"}),"Qovery Community Forum"),"."))}m.isMDXComponent=!0},473:function(e,t,n){var r;!function(){"use strict";var n={}.hasOwnProperty;function o(){for(var e=[],t=0;t<arguments.length;t++){var r=arguments[t];if(r){var a=typeof r;if("string"===a||"number"===a)e.push(r);else if(Array.isArray(r)&&r.length){var i=o.apply(null,r);i&&e.push(i)}else if("object"===a)for(var l in r)n.call(r,l)&&r[l]&&e.push(l)}}return e.join(" ")}e.exports?(o.default=o,e.exports=o):void 0===(r=function(){return o}.apply(t,[]))||(e.exports=r)}()},474:function(e,t,n){"use strict";n(476);var r=n(0),o=n.n(r),a=n(473),i=n.n(a);n(132);t.a=function(e){var t=e.children,n=e.classNames,r=e.fill,a=e.icon,l=e.type,s=null;switch(l){case"danger":s="alert-triangle";break;case"success":s="check-circle";break;case"warning":s="alert-triangle";break;default:s="info"}return o.a.createElement("div",{className:i()(n,"alert","alert--"+l,{"alert--fill":r,"alert--icon":!1!==a}),role:"alert"},!1!==a&&o.a.createElement("i",{className:i()("feather","icon-"+(a||s))}),t)}},475:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var r=n(0),o=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=o.a.createContext({}),p=function(e){var t=o.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l({},t,{},e)),n},u=function(e){var t=p(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=Object(r.forwardRef)((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=r,b=u["".concat(i,".").concat(d)]||u[d]||m[d]||a;return n?o.a.createElement(b,l({ref:t},c,{components:n})):o.a.createElement(b,l({ref:t},c))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<a;c++)i[c]=n[c];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},476:function(e,t,n){var r=n(12);r(r.P,"Array",{fill:n(477)}),n(74)("fill")},477:function(e,t,n){"use strict";var r=n(27),o=n(75),a=n(26);e.exports=function(e){for(var t=r(this),n=a(t.length),i=arguments.length,l=o(i>1?arguments[1]:void 0,n),s=i>2?arguments[2]:void 0,c=void 0===s?n:o(s,n);c>l;)t[l++]=e;return t}},478:function(e,t,n){var r=n(28).f,o=Function.prototype,a=/^\s*function ([^ (]*)/;"name"in o||n(10)&&r(o,"name",{configurable:!0,get:function(){try{return(""+this).match(a)[1]}catch(e){return""}}})},479:function(e,t,n){"use strict";n(478);var r=n(0),o=n.n(r),a=n(474);t.a=function(e){var t=e.children,n=e.name;return o.a.createElement(a.a,{type:"info",fill:!0,icon:!1,rounded:!0,className:"list--icons list--icons--arrow list--tight list--indent margin-bottom--lg"},o.a.createElement("p",{class:"text--lg margin-bottom--sm",style:{marginTop:"-0.25em"}},"Before you begin, this ",n||"page"," assumes the following:"),t)}},480:function(e,t,n){"use strict";var r=n(1),o=n(0),a=n.n(o),i=n(39),l=n(484),s=n(20),c=n.n(s);t.a=function(e){var t,n=e.to,s=e.href,p=n||s,u=Object(l.a)(p),m=Object(o.useRef)(!1),d=c.a.canUseIntersectionObserver;return Object(o.useEffect)((function(){return!d&&u&&window.docusaurus.prefetch(p),function(){d&&t&&t.disconnect()}}),[p,d,u]),p&&u?a.a.createElement(i.b,Object(r.a)({},e,{onMouseEnter:function(){m.current||(window.docusaurus.preload(p),m.current=!0)},innerRef:function(e){var n,r;d&&e&&u&&(n=e,r=function(){window.docusaurus.prefetch(p)},(t=new window.IntersectionObserver((function(e){e.forEach((function(e){n===e.target&&(e.isIntersecting||e.intersectionRatio>0)&&(t.unobserve(n),t.disconnect(),r())}))}))).observe(n))},to:p})):a.a.createElement("a",Object(r.a)({},e,{href:p}))}},483:function(e,t,n){"use strict";var r=n(0),o=n.n(r),a=n(480),i=n(473),l=n.n(i);n(134);t.a=function(e){var t=e.children,n=e.className,r=e.badge,i=e.leftIcon,s=e.rightIcon,c=e.size,p=e.target,u=e.to,m=l()("jump-to","jump-to--"+c,n),d=o.a.createElement("div",{className:"jump-to--inner"},o.a.createElement("div",{className:"jump-to--inner-2"},i&&o.a.createElement("div",{className:"jump-to--left"},o.a.createElement("i",{className:"feather icon-"+i})),o.a.createElement("div",{className:"jump-to--main"},r?o.a.createElement("span",{className:"badge badge--primary badge--right"},r):"",t),o.a.createElement("div",{className:"jump-to--right"},o.a.createElement("i",{className:"feather icon-"+(s||"chevron-right")+" arrow"}))));return p?o.a.createElement("a",{href:u,target:p,className:m},d):o.a.createElement(a.a,{to:u,className:m},d)}},484:function(e,t,n){"use strict";function r(e){return!1===/^(https?:|\/\/)/.test(e)}n.d(t,"a",(function(){return r}))}}]);
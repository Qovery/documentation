<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<link rel="preconnect" href="https://phprox.qovery.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,c){function a(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var g=e;for(void 0!==c?g=e[c]=[]:c="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==c&&(e+="."+c),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)a(g,o[p]);e._i.push([r,s,c])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_IgdG1K2GveDUte1gJ6hlwNbFHCv9nViWETUyLMU7ciq",{api_host:"https://phprox.qovery.com"})</script>
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Qovery Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Qovery Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">
<script src="/js/intercom.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=UA-129773960-5" async></script>
<script src="/js/ga.js"></script>

<title data-react-helmet="true">Use AWS IAM roles with Qovery | Qovery</title>

<meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"><meta data-react-helmet="true" property="og:title" content="Use AWS IAM roles with Qovery | Qovery"><meta data-react-helmet="true" name="description" content="Use AWS IAM roles with Qovery, in minutes, for free"><meta data-react-helmet="true" property="og:description" content="Use AWS IAM roles with Qovery, in minutes, for free"><meta data-react-helmet="true" property="og:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" property="twitter:image" content="https://hub.qovery.com/img/open-graph.png"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Use AWS IAM roles with Qovery | Qovery"><meta data-react-helmet="true" property="og:url" content="https://docs.qovery.com/guides/tutorial/use-aws-iam-roles-with-qovery/"><meta data-react-helmet="true" name="twitter:card" content="summary">

<link data-react-helmet="true" rel="shortcut icon" href="/img/logo-square.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.qovery.com/guides/tutorial/use-aws-iam-roles-with-qovery/">


<link rel="stylesheet" href="/styles.ce3a7d36.css">


<link rel="preload" href="/styles.f748a9e1.js" as="script">

<link rel="preload" href="/runtime~main.27008c89.js" as="script">

<link rel="preload" href="/main.17427b9e.js" as="script">

<link rel="preload" href="/1.1924c583.js" as="script">

<link rel="preload" href="/2.5f88e179.js" as="script">

<link rel="preload" href="/3.b1898c7d.js" as="script">

<link rel="preload" href="/1c13b173.4e61bc99.js" as="script">

<link rel="preload" href="/5b5f8b70.a08706af.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_2ZIa"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/tutorial">Tutorials</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://start.qovery.com">Web Console</a><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"><i class="feather icon-github"></i> </a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_16CL"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/">Guides</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides/tutorial">Tutorials</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://discuss.qovery.com">Forum</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://start.qovery.com">Web Console</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" target="_blank" rel="noopener noreferrer" href="https://www.qovery.com">Home</a></li><li class="menu__list-item"><a class="navbar__item navbar__link" title="GitHub" target="_blank" rel="noopener noreferrer" href="https://github.com/Qovery"></a></li></ul></div></div></div></nav><div class="main-wrapper"><header class="hero domain-bg domain-bg--default"><div class="container"><div class="hero--category"><a aria-current="page" class="active" href="/guides/tutorial/">tutorial</a></div><h1 class="header_1mJE">Use AWS IAM roles with Qovery</h1><div class="hero--subtitle">Give AWS IAM permissions to your application/container/job with Qovery</div><div class="tags_3AF9"><a class="badge badge--rounded badge--pink" href="/guides/tags/type-tutorial/">type: tutorial</a><a class="badge badge--rounded badge--primary" href="/guides/tags/technology-qovery/">technology: qovery</a></div></div></header><main class="container container--l container_1ncB"><aside class="sidebar_1pU0"><section class="avatar_1sJg"><div class="avatar avatar--lg avatar--vertical"><img class="avatar__photo avatar__photo--lg" src="https://github.com/deimosfr.png"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/deimosfr" target="_blank" rel="author">Pierre M.</a></div><small class="avatar__subtitle">Pierre is an SRE, and CTO of <a href="https://www.qovery.com">Qovery</a>. He has 15+ years of experience in R&D. From the financial to the Ad-Tech industry, he has a strong knowledge in distributed and highly-reliable systems. He's also the <a href="https://www.amazon.fr/MariaDB-High-Performance-Pierre-MAVRO/dp/1783981601">MariaDB High Performance</a> book author.
</small></div></div></section><section class="table-of-contents tableOfContents_1eMQ"><div class="section"><div class="title">Stats</div><div class="text--secondary text--bold"><i class="feather icon-book"></i> 8 min read</div><div class="text--secondary text--bold"><i class="feather icon-clock"></i> Updated <time pubdate="pubdate" datetime="2023-04-22">Apr 22nd, 2023</time></div></div><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#overview" class="contents__link">Overview</a></li><li><a href="#application-requiring-s3-permissions" class="contents__link">Application requiring S3 permissions</a><ul><li><a href="#create-an-application" class="contents__link">Create an application</a></li><li><a href="#get-kubernetes-namespace-name" class="contents__link">Get Kubernetes namespace name</a></li></ul></li><li><a href="#configure-oidc-provider" class="contents__link">Configure OIDC provider</a><ul><li><a href="#get-your-cluster-oidc-provider-url" class="contents__link">Get your Cluster OIDC provider URL</a></li><li><a href="#create-an-identity-provider" class="contents__link">Create an Identity provider</a></li></ul></li><li><a href="#configure-aws-iam-roles" class="contents__link">Configure AWS IAM roles</a><ul><li><a href="#create-a-role" class="contents__link">Create a role</a></li><li><a href="#role-permissions" class="contents__link">Role permissions</a></li><li><a href="#configure-trusted-entities" class="contents__link">Configure trusted entities</a></li></ul></li><li><a href="#create-a-service-account" class="contents__link">Create a service account</a><ul><li><a href="#kubernetes-authentication" class="contents__link">Kubernetes authentication</a></li><li><a href="#create-a-lifecycle-job" class="contents__link">Create a Lifecycle job</a></li></ul></li><li><a href="#set-application-service-account" class="contents__link">Set application service account</a><ul><li><a href="#set-service-account" class="contents__link">Set service account</a></li><li><a href="#validate-access" class="contents__link">Validate access</a></li></ul></li><li><a href="#conclusion" class="contents__link">Conclusion</a></li></ul></div></section></aside><div class="article_mCV7"><article><div class="markdown"><a aria-hidden="true" tabindex="-1" class="anchor" id="overview"></a><p>AWS IAM (Identity &amp; Access Management) service allows AWS services to interact with each other by using roles. Those roles can easily be used to give permissions to your Qovery application, container or job.</p><p>It is a secure way to give your application permissions without having to manage credentials. More than that, it rotates the token automatically.</p><p>This tutorial will show you how to add AWS IAM roles to your Qovery application, container or job.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="application-requiring-s3-permissions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#application-requiring-s3-permissions" title="Direct link to heading">#</a>Application requiring S3 permissions</h2><p>In this first step, we will create a simple application that needs AWS permissions to access s3 buckets.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="create-an-application"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-an-application" title="Direct link to heading">#</a>Create an application</h3><p>We are going to will create a simple container, but you can use an existing one if you want (or an application or job). </p><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i><p>You do not have to deploy it now, just create one container this way.</p></div><p>Here is a simple Debian container example:</p><p valign="center"><img src="/img/aws-iam-assume-role/debian_app.png" alt="debian app"></p><p>Set only 1 instance and 128MB of memory is enough for this example. Then continue until you have the <code>Create</code> button, there is nothing more to setup.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="get-kubernetes-namespace-name"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#get-kubernetes-namespace-name" title="Direct link to heading">#</a>Get Kubernetes namespace name</h3><p>Then in this container (or any application in this environment) <code>Variables</code>, search for the variable called <code>QOVERY_KUBERNETES_NAMESPACE_NAME</code> and copy its value somewhere.</p><p valign="center"><img src="/img/aws-iam-assume-role/debian_namespace.png" alt="debian app"></p><p>It is the Kubernetes namespace name where the container is located.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="configure-oidc-provider"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configure-oidc-provider" title="Direct link to heading">#</a>Configure OIDC provider</h2><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i><p>This step should be done only once per cluster</p></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="get-your-cluster-oidc-provider-url"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#get-your-cluster-oidc-provider-url" title="Direct link to heading">#</a>Get your Cluster OIDC provider URL</h3><p>On your AWS console, go to your EKS cluster and <code>Overview</code> section. Copy the <code>OpenID Connect provider URL</code>:</p><p valign="center"><img src="/img/aws-iam-assume-role/eks_oidc.png" alt="EKS OIDC"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="create-an-identity-provider"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-an-identity-provider" title="Direct link to heading">#</a>Create an Identity provider</h3><p>On your AWS console, go to <code>IAM</code> service, then <code>Identity providers</code> section, and <code>Add provider</code> button:</p><ol><li>Select the <code>OpenID Connect</code> provider type</li><li>Paste the <code>OpenID Connect provider URL</code> previously copied to <code>Provider URL</code></li><li>Click on <code>Get thumbprint</code> button, once done the button will change to <code>Edit URL</code></li><li>Add <code>sts.amazonaws.com</code> as <code>Audience</code></li><li>Click on <code>Add provider</code> button</li></ol><p valign="center"><img src="/img/aws-iam-assume-role/oidc_connect.png" alt="OIDC Connect"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="configure-aws-iam-roles"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configure-aws-iam-roles" title="Direct link to heading">#</a>Configure AWS IAM roles</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="create-a-role"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-a-role" title="Direct link to heading">#</a>Create a role</h3><p>Now we can create a role. In the <code>IAM</code> service, go to <code>Roles</code> section, and click on <code>Create role</code> button.</p><p>You have to select the Trusted entity type. For this tutorial, we are going to use the <code>Web identity</code> type.</p><p>Set the <code>Identity provider</code> to the one you just created, and the <code>Audience</code> to <code>sts.amazonaws.com</code>. Then click on the <code>Next</code> button.</p><p valign="center"><img src="/img/aws-iam-assume-role/role_create_step1.png" alt="Role create step 1"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="role-permissions"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#role-permissions" title="Direct link to heading">#</a>Role permissions</h3><p>Select the policy of your choice. For this example, the policy <code>AmazonS3ReadOnlyAccess</code> will be used to list S3 buckets. Then click on the <code>Next</code> button.</p><p>To finish, set the role name and description of your choice and click on <code>Create role</code> button.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="configure-trusted-entities"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#configure-trusted-entities" title="Direct link to heading">#</a>Configure trusted entities</h3><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="qovery-environment-scoped-role"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#qovery-environment-scoped-role" title="Direct link to heading">#</a>Qovery environment scoped role</h4><p>Once created, select your freshly created role, go to the <code>Trust relationships</code> tab, and click on <code>Edit trust policy</code> button.</p><p valign="center"><img src="/img/aws-iam-assume-role/role_trusted_entities_default.png" alt="role trusted default"></p><p>Update the policy line regarding the <code>OIDC</code> condition from:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-undefined codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">&quot;oidc.eks.eu-west-3.amazonaws.com/id/xxxxxxx:aud&quot;: &quot;sts.amazonaws.com&quot;</span></div></div></pre></div></div><p>to:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-undefined codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">&quot;oidc.eks.eu-west-3.amazonaws.com/id/xxxxxxx:sub&quot;: &quot;system:serviceaccount:kubernetes_namespace:service_account_name&quot;</span></div></div></pre></div></div><p>Replace:</p><ul><li><code>kubernetes_namespace</code>: with the namespace name, corresponding to the Qovery environment (<a aria-current="page" class="active" href="/guides/tutorial/use-aws-iam-roles-with-qovery#get-kubernetes-namespace-name">previously copied in step 1</a>)</li><li><code>service_account_name</code>: define a service account name which will be re-use later (ex: <code>my-s3-role</code>)</li></ul><p>Once done, click on the <code>Update policy</code> button.</p><p>Last element to copy and save somewhere: is the role <code>ARN</code>.</p><p>In the end, you should have something like:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-json codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2012-10-17&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;Statement&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Effect&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Allow&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Principal&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;Federated&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;arn:aws:iam::yyyyyyy:oidc-provider/oidc.eks.us-east-2.amazonaws.com/id/xxxxxxx&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;Condition&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">&quot;StringEquals&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">&quot;oidc.eks.eu-west-3.amazonaws.com/id/xxxxxxx:sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:serviceaccount:kubernetes_namespace:service_account_name&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="cluster-scoped-role"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#cluster-scoped-role" title="Direct link to heading">#</a>Cluster scoped role</h4><p>If you want to be able to keep the Role and permissions with the &quot;On-demand environment&quot; and &quot;Clone&quot; features, then you have to scope the role &quot;cluster side&quot; instead of the &quot;Kubernetes namespace&quot; side.</p><p>To do so, update the <code>Condition</code> with <code>StringLike</code> instead of <code>StringEquals</code>, and use a wildcard instead of the namespace name:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-json codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;Condition&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;StringLike&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;oidc.eks.eu-west-3.amazonaws.com/id/xxxxxxx:sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:serviceaccount:z*:service_account_name&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><p>Replace:</p><ul><li><code>service_account_name</code>: define a service account name which will be re-use later (ex: <code>my-s3-role</code>)</li><li><code>z*</code>: the wildcard to use to match all namespaces deployed with Qovery</li></ul><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i><p>Do not forget to set the <a aria-current="page" class="active" href="/guides/tutorial/use-aws-iam-roles-with-qovery#create-a-service-account">Service Account</a> as well in those environments.</p></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="create-a-service-account"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-a-service-account" title="Direct link to heading">#</a>Create a service account</h2><div class="alert alert--info alert--icon" role="alert"><i class="feather icon-info"></i><p>If you already have an existing service account on your Kubernetes cluster and want to use it, you can skip this step.</p></div><div class="alert alert--warning alert--icon" role="alert"><i class="feather icon-alert-triangle"></i><p>Kubernetes reminder: <strong>a deployed service account in a Kubernetes namespace, becomes available by all applications in the same namespace.</strong></p></div><p>This step will help you on deploying a service account on your Kubernetes cluster. In case you want to do it manually on the cluster with <code>kubectl</code>, you just have to push a service account like:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-yaml codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $SERVICE_ACCOUNT_NAME</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $QOVERY_KUBERNETES_NAMESPACE_NAME</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">eks.amazonaws.com/role-arn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $AWS_ROLE_ARN</span></div></div></pre></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="kubernetes-authentication"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#kubernetes-authentication" title="Direct link to heading">#</a>Kubernetes authentication</h3><p>On AWS, there are <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-auth.html">several ways to authenticate to Kubernetes</a>. To make it simple, we are going to use a dedicated IAM user, but you can select the best method for your need.</p><p>From your AWS Console, create an IAM user account, get <code>Access key ID</code> and <code>Secret access key</code> and save them somewhere.</p><p>Qovery helps <a href="/guides/tutorial/how-to-connect-to-your-eks-cluster-with-kubectl/#add-your-iam-user-to-the-admin-group">IAM users to get quick access to the Kubernetes cluster</a>. Simply add this user to the <code>Admins</code> group.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="create-a-lifecycle-job"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#create-a-lifecycle-job" title="Direct link to heading">#</a>Create a Lifecycle job</h3><p>In the same environment than your application, create a <code>Lifecycle job</code> which will be used to deploy a service account on the Kubernetes cluster:</p><p valign="center"><img src="/img/aws-iam-assume-role/lifecycle_step1.png" alt="Lifecycle creation"></p><p>Here a container <code>qoveryrd/create-sa:1.0</code> available on <a href="https://hub.docker.com/r/qoveryrd/create-sa">DockerHub</a> made by Qovery is used, but you can fork <a href="https://github.com/Qovery/create_service_account">this repository</a> and update to your needs if you prefer.</p><p>Click on the <code>Continue</code> button and select the <code>Start</code> event because we want to deploy the service account at the environment start and <code>Delete</code> to delete it if we decide to remove it. Set parameters as well with the according action:</p><p valign="center"><img src="/img/aws-iam-assume-role/lifecycle_step2.png" alt="Lifecycle creation"></p><p>Then click on the <code>Continue</code> button, set the resources (128Mb is enough) and click on the <code>Continue</code> button.</p><p>Then add the following environment variables to the <code>job</code> scope:</p><ul><li><code>KUBERNETES_VERSION</code>: the version of your Kubernetes cluster which will be used to download kubectl (ex: 1.23.0)</li><li><code>SERVICE_ACCOUNT_NAME</code>: the name of the service account in Kubernetes (the same name <a aria-current="page" class="active" href="/guides/tutorial/use-aws-iam-roles-with-qovery#configure-trusted-entities">you have declared</a> for the role in the <code>Trusted entities</code> policy section)</li><li><code>AWS_ROLE_ARN</code>: the AWS ARN role you have just created</li><li><code>AWS_ACCESS_KEY_ID</code>: the AWS access key ID of the IAM user you have created (if you decided to use this authentication method)</li><li><code>AWS_SECRET_ACCESS_KEY</code>: the AWS secret access key of the IAM user you have created (if you decided to use this authentication method)</li></ul><p valign="center"><img src="/img/aws-iam-assume-role/lifecycle_step2.png" alt="Lifecycle creation"></p><p>Then <code>Create</code> the <code>Lifecycle job</code>. Go into the <code>Variables</code> tab and create a <code>Variable Alias</code> on <code>QOVERY_CLOUD_PROVIDER_REGION</code>, name it <code>AWS_DEFAULT_REGION</code> and scope it to the <code>job</code>.</p><p valign="center"><img src="/img/aws-iam-assume-role/lifecycle_step3.png" alt="Lifecycle creation"></p><p>You can now run your job by clicking on the <code>Deploy now</code> button. You should see the following output in your job logs:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-undefined codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">-&gt; Ensuring required environment variables are present</span></div><div class="token-line" style="color:#393A34"><span class="token plain">-&gt; Downloading kubectl version 1.23.0</span></div><div class="token-line" style="color:#393A34"><span class="token plain">-&gt; Generated service account:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">kind: ServiceAccount</span></div><div class="token-line" style="color:#393A34"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> name: my-s3-role</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> namespace: xxxxxx</span></div><div class="token-line" style="color:#393A34"><span class="token plain"> annotations:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">   eks.amazonaws.com/role-arn: arn:aws:iam::xxxxxx:role/my-s3-role</span></div><div class="token-line" style="color:#393A34"><span class="token plain">-&gt; Getting kubeconfig</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Added new context arn:aws:eks:region:id:cluster/cluster-name to /root/.kube/config</span></div><div class="token-line" style="color:#393A34"><span class="token plain">-&gt; Deploying service account</span></div><div class="token-line" style="color:#393A34"><span class="token plain">serviceaccount/aws-permissions created</span></div></div></pre></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="set-application-service-account"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#set-application-service-account" title="Direct link to heading">#</a>Set application service account</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="set-service-account"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#set-service-account" title="Direct link to heading">#</a>Set service account</h3><p>The final step is to set this service account (pointing to the AWS role) to your application. Go into your application <code>Advanced settings</code> and set the <code>Service account</code> to the one you have just created:</p><p valign="center"><img src="/img/aws-iam-assume-role/debian_sa.png" alt="Lifecycle creation"></p><p>Deploy your application with the <code>Deploy now</code> button.</p><p>At this stage, the job should have been executed and the service account should be deployed on your Kubernetes cluster, and the Debian container, running.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="validate-access"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#validate-access" title="Direct link to heading">#</a>Validate access</h3><p>To validate the AWS role has correctly been deployed, we can connect to the pod, and see if we have the AWS token. We will use the Qovery CLI to connect to our pod:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ qovery shell</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Qovery: Select organization</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Organization:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">✔ Qovery</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Qovery: Select project</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Project:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">✔ AWS roles tutorial</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Qovery: Select environment</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Environment:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">✔ aws-role</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Qovery: Select </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">Services:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">✔ debian</span></div></div></pre></div></div><p>Now we are connected to the pod, we can check the AWS token:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> AWS</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">AWS_DEFAULT_REGION</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">us-east-2</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">AWS_REGION</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">us-east-2</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">AWS_ROLE_ARN</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">arn:aws:iam::xxxxxx:role/my-s3-role</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">AWS_WEB_IDENTITY_TOKEN_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/run/secrets/eks.amazonaws.com/serviceaccount/token</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">AWS_STS_REGIONAL_ENDPOINTS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">regional</span></div></div></pre></div></div><p>Token is here! Let&#x27;s install the AWS CLI and validate the role access. We should be able to list S3 buckets:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-bash codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> update </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> awscli</span></div><div class="token-line" style="color:#393A34"><span class="token plain">$ aws s3 </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2022</span><span class="token plain">-09-23 06:56:38 aws-cloudtrail-logs-qovery</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span></div></div></pre></div></div><p>It works! We have access to S3 buckets using the AWS role.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="conclusion"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#conclusion" title="Direct link to heading">#</a>Conclusion</h2><p>The first setup phase can be time-consuming. However, once done, applying roles to your applications is very easy and fast. You can now use roles to access any AWS service!</p></div></article></div></main></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><p>Qovery is a Self-Service Infrastructure Platform Helping Ops and Engineers To Ship Faster.</p></div><div><a href="https://github.com/qovery" target="_blank"><i class="feather icon-github" alt="Qovery&#x27;s Github Repo"></i></a>    <a href="https://www.linkedin.com/company/qovery/" target="_blank"><i class="feather icon-rss" alt="Qovery&#x27;s Linkedin"></i></a>    <a href="https://twitter.com/qovery_" target="_blank"><i class="feather icon-twitter" alt="Qovery&#x27;s Twitter"></i></a>    <a href="https://discord.qovery.com" target="_blank"><i class="feather icon-message-circle" alt="Qovery&#x27;s Discord"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">Resources</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides">Guides</a></li><li class="footer__item"><a aria-current="page" class="footer__link-item active" href="/guides/tutorial">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/guides/engineering">Engineering</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/pricing" href="https://www.qovery.com/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/enterprise" href="https://www.qovery.com/enterprise">Enterprise</a></li><li class="footer__item"><a class="footer__link-item" to="https://api-doc.qovery.com" href="https://api-doc.qovery.com">API</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery" href="https://github.com/Qovery">Github</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://discord.qovery.com" href="https://discord.qovery.com">Discord</a></li><li class="footer__item"><a class="footer__link-item" to="https://community.qovery.com" href="https://community.qovery.com">Forum</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/community-call" href="https://www.qovery.com/community-call">Community call</a></li><li class="footer__item"><a class="footer__link-item" to="https://shop.qovery.com" href="https://shop.qovery.com">Goodies</a></li><li class="footer__item"><a class="footer__link-item" to="https://roadmap.qovery.com" href="https://roadmap.qovery.com">Roadmap</a></li><li class="footer__item"><a class="footer__link-item" to="https://github.com/Qovery/replibyte" href="https://github.com/Qovery/replibyte">Replibyte</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/blog" href="https://www.qovery.com/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" to="https://jobs.qovery.com" href="https://jobs.qovery.com">Jobs</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/team" href="https://www.qovery.com/team">Team</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/investors" href="https://www.qovery.com/investors">Investors</a></li><li class="footer__item"><a class="footer__link-item" to="https://www.qovery.com/contact" href="https://www.qovery.com/contact">Contact</a></li></ul></div></div><div class="text--center"><small>© 2023 DESIGNED BY QOVERY | BACKED BY TECHSTARS | PROUD SILVER MEMBER OF CNCF AND LINUX FOUNDATION | QOVERY BY BIRDSIGHT - ALL RIGHTS RESERVED</small><br></div></div></footer>
</div>

<script src="/styles.f748a9e1.js"></script>

<script src="/runtime~main.27008c89.js"></script>

<script src="/main.17427b9e.js"></script>

<script src="/1.1924c583.js"></script>

<script src="/2.5f88e179.js"></script>

<script src="/3.b1898c7d.js"></script>

<script src="/1c13b173.4e61bc99.js"></script>

<script src="/5b5f8b70.a08706af.js"></script>


</body>
</html>